<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Property Record Assistant - SLTR</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Tesseract.js for OCR -->
<script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>

<script>
// Tailwind config
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#3b82f6',
        'primary-foreground': '#ffffff',
        muted: '#f3f4f6',
        'muted-foreground': '#6b7280',
        border: '#e5e7eb',
        destructive: '#ef4444',
        'destructive-foreground': '#ffffff',
        secondary: '#f1f5f9',
        'secondary-foreground': '#0f172a',
      }
    }
  }
}
</script>

<style>
/* Loading spinner animation */
.loading-spinner {
  width: 1rem;
  height: 1rem;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* File drop zone styles */
.file-drop-zone {
  border: 2px dashed #d1d5db;
  transition: all 0.3s ease;
}

.file-drop-zone:hover {
  border-color: #3b82f6;
  background-color: #f8fafc;
}

.file-drop-zone.dragover {
  border-color: #3b82f6;
  background-color: #eff6ff;
}

/* Progress bar animation */
.progress-bar {
  transition: width 0.5s ease-in-out;
}

/* AI stage indicator animations */
.stage-indicator {
  transition: all 0.3s ease;
}

.stage-indicator.active {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Modal backdrop */
.modal-backdrop {
  background-color: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

/* Badge styles */
.badge {
  display: inline-flex;
  align-items: center;
  border-radius: 9999px;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-success {
  background-color: #dcfce7;
  color: #166534;
}

.badge-warning {
  background-color: #fef3c7;
  color: #92400e;
}

.badge-error {
  background-color: #fee2e2;
  color: #991b1b;
}

.badge-default {
  background-color: #f3f4f6;
  color: #374151;
}

/* Collapsible content */
.collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.collapsible-content.expanded {
  max-height: 2000px;
}

/* Instrument card styles */
.instrument-card {
  border-left: 4px solid #3b82f6;
}

.instrument-card.editing {
  border-left-color: #10b981;
}
</style>
</head>
<body class="min-h-screen bg-gray-50">

<div class="container mx-auto py-6 space-y-6 max-w-6xl px-4 sm:px-6 lg:px-8">
  
  <!-- Page Header -->
  <div class="space-y-2">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900">AI Property Record Assistant</h1>
    <p class="text-lg text-gray-600">Upload property documents for automated data extraction and record creation</p>
  </div>

  <!-- File Upload Card -->
  <div class="bg-white rounded-lg shadow border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Upload Property Record(s) for AI Extraction</h2>
      <p class="text-sm text-gray-600 mt-1">Upload an image (JPEG, PNG) or PDF of the property document (e.g., Deed of Assignment, C of O).</p>
    </div>
    
    <div class="p-6 space-y-4">
      <!-- Error Alert -->
      <div id="error-alert" class="hidden bg-red-50 border border-red-200 rounded-md p-4">
        <div class="flex">
          <i data-lucide="alert-circle" class="h-5 w-5 text-red-400"></i>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Error</h3>
            <div id="error-message" class="mt-2 text-sm text-red-700"></div>
          </div>
        </div>
      </div>

      <!-- File Upload Area -->
      <div class="space-y-1">
        <label class="block text-sm font-medium text-gray-700">Document File</label>
        <input
          id="file-input"
          type="file"
          accept="image/jpeg,image/png,application/pdf"
          class="hidden"
        />
        <button
          id="file-upload-btn"
          class="w-full flex items-center justify-start px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left font-normal hover:bg-gray-50 transition-colors"
        >
          <i data-lucide="file-up" class="mr-2 h-4 w-4"></i>
          <span id="file-upload-text">Click to select a file</span>
        </button>
      </div>

      <!-- Image Preview -->
      <div id="image-preview" class="hidden border p-2 rounded-md">
        <label class="text-xs text-gray-500">Image Preview</label>
        <img id="image-preview-img" class="max-w-full h-auto max-h-96 rounded-md mt-1" />
      </div>

      <!-- PDF Preview -->
      <div id="pdf-preview" class="hidden border p-2 rounded-md space-y-2">
        <label id="pdf-preview-label" class="text-xs text-gray-500">PDF Preview</label>
        <div class="relative">
          <img id="pdf-preview-img" class="max-w-full h-auto max-h-[30rem] rounded-md mt-1 border mx-auto" />
        </div>
        <div id="pdf-navigation" class="hidden flex justify-center items-center space-x-2 mt-2">
          <button id="pdf-prev-btn" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-3 py-1 transition-all cursor-pointer bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50">
            Previous
          </button>
          <span id="pdf-page-info" class="text-sm text-gray-500">Page 1 / 1</span>
          <button id="pdf-next-btn" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-3 py-1 transition-all cursor-pointer bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50">
            Next
          </button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="px-6 pb-6 flex flex-col sm:flex-row gap-2">
      <button
        id="start-ai-btn"
        class="w-full sm:w-auto inline-flex items-center justify-center rounded-md font-medium text-sm px-4 py-2 transition-all cursor-pointer border-0 bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        <i data-lucide="wand-2" class="mr-2 h-4 w-4"></i>
        Extract Data with AI
      </button>
      <button
        id="reset-btn"
        class="hidden w-full sm:w-auto inline-flex items-center justify-center rounded-md font-medium text-sm px-4 py-2 transition-all cursor-pointer bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50"
      >
        Reset
      </button>
    </div>
  </div>

  <!-- AI Processing Visualizer -->
  <div id="ai-processing" class="hidden bg-white rounded-lg shadow border border-gray-200">
    <div class="p-6">
      <div class="flex justify-between mb-2">
        <span class="text-sm font-medium">Property Document AI Analysis</span>
        <span id="ai-progress-text" class="text-sm">0% Complete</span>
      </div>
      <div class="relative">
        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="ai-progress-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500 ease-in-out" style="width: 0%"></div>
        </div>
        <div class="flex justify-between mt-2">
          <div class="flex flex-col items-center stage-indicator" data-stage="0">
            <div class="w-4 h-4 rounded-full bg-gray-300 mb-1"></div>
            <span class="text-xs text-gray-500">Init</span>
          </div>
          <div class="flex flex-col items-center stage-indicator" data-stage="1">
            <div class="w-4 h-4 rounded-full bg-gray-300 mb-1"></div>
            <span class="text-xs text-gray-500">OCR</span>
          </div>
          <div class="flex flex-col items-center stage-indicator" data-stage="2">
            <div class="w-4 h-4 rounded-full bg-gray-300 mb-1"></div>
            <span class="text-xs text-gray-500">Layout</span>
          </div>
          <div class="flex flex-col items-center stage-indicator" data-stage="3">
            <div class="w-4 h-4 rounded-full bg-gray-300 mb-1"></div>
            <span class="text-xs text-gray-500">Extract</span>
          </div>
          <div class="flex flex-col items-center stage-indicator" data-stage="4">
            <div class="w-4 h-4 rounded-full bg-gray-300 mb-1"></div>
            <span class="text-xs text-gray-500">Assemble</span>
          </div>
          <div class="flex flex-col items-center stage-indicator" data-stage="5">
            <div class="w-4 h-4 rounded-full bg-gray-300 mb-1"></div>
            <span class="text-xs text-gray-500">Done</span>
          </div>
        </div>
      </div>
      <div class="mt-4 flex items-start gap-3">
        <div class="p-2 rounded-full bg-blue-100">
          <i id="ai-stage-icon" data-lucide="brain" class="h-5 w-5 text-blue-600"></i>
        </div>
        <div>
          <p id="ai-stage-title" class="text-sm font-medium mb-1">Current Stage: Initializing</p>
          <p id="ai-stage-description" class="text-xs text-gray-600">Preparing for AI analysis...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Keyword Findings Display -->
  <div id="keyword-findings" class="hidden bg-white rounded-lg shadow border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center space-x-2">
        <i data-lucide="file-key-2" class="h-6 w-6 text-blue-600"></i>
        <h3 class="text-xl font-semibold text-gray-900">Key Document Types Found</h3>
      </div>
      <p id="keyword-findings-description" class="text-sm text-gray-600 mt-1"></p>
    </div>
    <div class="p-6">
      <ul id="keyword-findings-list" class="space-y-2">
        <!-- Keyword findings will be inserted here -->
      </ul>
    </div>
  </div>

  <!-- Raw Extracted Text -->
  <div id="raw-text-card" class="hidden bg-white rounded-lg shadow border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-semibold text-gray-900">Raw Extracted Text</h3>
        <button id="toggle-raw-text" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-3 py-1 transition-all cursor-pointer bg-transparent text-gray-700 hover:bg-gray-100">
          <i data-lucide="chevron-down" class="h-4 w-4"></i>
          Show
        </button>
      </div>
    </div>
    <div id="raw-text-content" class="collapsible-content">
      <div class="p-6">
        <textarea id="raw-text-textarea" readonly rows="10" class="w-full text-xs bg-gray-50 font-mono border border-gray-300 rounded-md p-3"></textarea>
      </div>
    </div>
  </div>

  <!-- Extracted Property Details -->
  <div id="extracted-details" class="hidden bg-white rounded-lg shadow border-l-4 border-l-green-500">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center space-x-2">
        <i data-lucide="check-circle" class="h-6 w-6 text-green-600"></i>
        <h3 class="text-xl font-semibold text-gray-900">AI Extracted Property Details</h3>
      </div>
      <p id="extraction-confidence" class="text-sm text-gray-600 mt-1">
        Review the details extracted by the AI. Add or modify instruments as needed, then save the record.
      </p>
    </div>
    
    <div class="p-6 space-y-6">
      <!-- Property Information Form -->
      <div class="space-y-4">
        <h4 class="text-lg font-medium text-gray-900 border-b pb-2">Property Information</h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">File Number Type</label>
            <select id="file-number-type" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10">
              <option value="">Select type</option>
              <option value="kangisFileNo">KANGIS File No</option>
              <option value="mlsFileNo">MLS File No</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">File Prefix</label>
            <input id="file-prefix" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10" placeholder="e.g., LKN/RES" />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">File Serial No</label>
            <input id="file-serial-no" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10" placeholder="e.g., 2024/001" />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Complete File No</label>
            <input id="complete-file-no" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10" placeholder="Auto-generated" readonly />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Plot No</label>
            <input id="plot-no" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10" placeholder="e.g., Plot 123" />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">LGA/City</label>
            <input id="lga-city" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10" placeholder="e.g., Lokoja" />
          </div>
        </div>
        
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">Property Description</label>
          <textarea id="property-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10" placeholder="Detailed property description..."></textarea>
        </div>
      </div>

      <!-- Instruments Manager -->
      <div class="border-t pt-6">
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h4 class="text-lg font-medium text-gray-900">Document Instruments</h4>
            <button id="add-instrument-btn" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-3 py-1 transition-all cursor-pointer bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50 gap-2">
              <i data-lucide="plus" class="h-4 w-4"></i>
              Add Instrument
            </button>
          </div>
          
          <!-- No Instruments State -->
          <div id="no-instruments" class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
            <i data-lucide="file-key-2" class="h-8 w-8 mx-auto mb-2 text-gray-400"></i>
            <p class="text-sm">No instruments added yet</p>
            <p class="text-xs text-gray-400">Click "Add Instrument" to get started</p>
          </div>
          
          <!-- Instruments List -->
          <div id="instruments-list" class="space-y-3">
            <!-- Instruments will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="flex justify-end pt-4 border-t">
        <button id="save-record-btn" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-4 py-2 transition-all cursor-pointer border-0 bg-green-600 text-white hover:bg-green-700 gap-2">
          <i data-lucide="check-circle" class="h-4 w-4"></i>
          Save Property Record
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
  <!-- Toast messages will be inserted here -->
</div>

<script>
// Global state
let selectedFile = null;
let previewUrl = null;
let pdfPagePreviews = [];
let currentPdfPreviewPageIdx = 0;
let rawExtractedText = '';
let extractedPropertyData = null;
let keywordFindings = {};
let currentAiStage = 'idle';
let aiProgress = 0;
let instruments = [];
let editingInstrumentId = null;

// Initialize PDF.js
if (window.pdfjsLib) {
  window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Lucide icons
  lucide.createIcons();
  
  // Set up event listeners
  setupEventListeners();
  
  // Update UI
  updateUI();
});

function setupEventListeners() {
  // File input
  const fileInput = document.getElementById('file-input');
  const fileUploadBtn = document.getElementById('file-upload-btn');
  
  fileInput.addEventListener('change', handleFileChange);
  fileUploadBtn.addEventListener('click', () => fileInput.click());
  
  // Action buttons
  document.getElementById('start-ai-btn').addEventListener('click', startAiPropertyProcessing);
  document.getElementById('reset-btn').addEventListener('click', resetState);
  
  // PDF navigation
  document.getElementById('pdf-prev-btn').addEventListener('click', handlePrevPdfPage);
  document.getElementById('pdf-next-btn').addEventListener('click', handleNextPdfPage);
  
  // Raw text toggle
  document.getElementById('toggle-raw-text').addEventListener('click', toggleRawText);
  
  // Instruments
  document.getElementById('add-instrument-btn').addEventListener('click', addInstrument);
  
  // Property form auto-generation
  document.getElementById('file-prefix').addEventListener('input', updateCompleteFileNo);
  document.getElementById('file-serial-no').addEventListener('input', updateCompleteFileNo);
  
  // Save record
  document.getElementById('save-record-btn').addEventListener('click', handleSaveRecord);
}

async function handleFileChange(event) {
  const file = event.target.files?.[0];
  if (file) {
    if (file.type.startsWith('image/') || file.type === 'application/pdf') {
      selectedFile = file;
      hideError();
      resetExtractionState();
      
      document.getElementById('file-upload-text').textContent = file.name;
      
      if (file.type === 'application/pdf') {
        document.getElementById('image-preview').classList.add('hidden');
        const pages = await renderPDFPagesToImages(file);
        pdfPagePreviews = pages;
        currentPdfPreviewPageIdx = 0;
        if (pages.length > 0) {
          showPdfPreview();
        }
      } else {
        document.getElementById('pdf-preview').classList.add('hidden');
        previewUrl = URL.createObjectURL(file);
        showImagePreview();
      }
      
      updateUI();
    } else {
      showError('Invalid file type. Please upload an image (JPEG, PNG) or PDF.');
      resetFileState();
    }
  }
}

function showImagePreview() {
  const preview = document.getElementById('image-preview');
  const img = document.getElementById('image-preview-img');
  img.src = previewUrl;
  preview.classList.remove('hidden');
}

function showPdfPreview() {
  const preview = document.getElementById('pdf-preview');
  const img = document.getElementById('pdf-preview-img');
  const label = document.getElementById('pdf-preview-label');
  const navigation = document.getElementById('pdf-navigation');
  const pageInfo = document.getElementById('pdf-page-info');
  
  if (pdfPagePreviews.length > 0) {
    img.src = pdfPagePreviews[currentPdfPreviewPageIdx];
    label.textContent = `PDF Preview (Page ${currentPdfPreviewPageIdx + 1} of ${pdfPagePreviews.length})`;
    pageInfo.textContent = `Page ${currentPdfPreviewPageIdx + 1} / ${pdfPagePreviews.length}`;
    
    if (pdfPagePreviews.length > 1) {
      navigation.classList.remove('hidden');
    }
    
    preview.classList.remove('hidden');
    updatePdfNavigation();
  }
}

function updatePdfNavigation() {
  const prevBtn = document.getElementById('pdf-prev-btn');
  const nextBtn = document.getElementById('pdf-next-btn');
  
  prevBtn.disabled = currentPdfPreviewPageIdx === 0;
  nextBtn.disabled = currentPdfPreviewPageIdx === pdfPagePreviews.length - 1;
  
  if (prevBtn.disabled) {
    prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
  } else {
    prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  }
  
  if (nextBtn.disabled) {
    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
  } else {
    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  }
}

function handlePrevPdfPage() {
  if (currentPdfPreviewPageIdx > 0) {
    currentPdfPreviewPageIdx--;
    showPdfPreview();
  }
}

function handleNextPdfPage() {
  if (currentPdfPreviewPageIdx < pdfPagePreviews.length - 1) {
    currentPdfPreviewPageIdx++;
    showPdfPreview();
  }
}

async function renderPDFPagesToImages(file) {
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const pageImages = [];
    
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      if (!context) throw new Error('Could not get canvas context');
      
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      pageImages.push(canvas.toDataURL('image/png'));
    }
    
    return pageImages;
  } catch (error) {
    console.error('Error rendering PDF pages:', error);
    showToast('Failed to render PDF for preview.', 'error');
    return [];
  }
}

async function startAiPropertyProcessing() {
  if (!selectedFile) {
    showToast('Please select a document file first.', 'error');
    return;
  }
  
  currentAiStage = 'initializing';
  aiProgress = 5;
  
  showAiProcessing();
  updateAiProcessingUI();
  
  await new Promise(res => setTimeout(res, 200));
  
  aiProgress = 10;
  currentAiStage = 'ocr';
  updateAiProcessingUI();
  
  try {
    let text = '';
    if (selectedFile.type === 'application/pdf') {
      text = await extractTextFromPropertyDocumentPDF(selectedFile);
    } else if (selectedFile.type.startsWith('image/')) {
      text = await extractTextFromPropertyDocumentImage(selectedFile);
    } else {
      throw new Error('Unsupported file type for AI processing.');
    }
    
    rawExtractedText = text;
    keywordFindings = analyzeTextForKeywords(text);
    
    currentAiStage = 'layoutAnalysis';
    aiProgress = Math.min(65, aiProgress + 10);
    updateAiProcessingUI();
    
    await new Promise(res => setTimeout(res, 100));
    
    currentAiStage = 'dataExtraction';
    updateAiProcessingUI();
    
    const extractedDetails = extractPropertyInstrumentDetails(text, selectedFile.name);
    
    aiProgress = Math.min(85, aiProgress + 20);
    currentAiStage = 'dataAssembly';
    updateAiProcessingUI();
    
    const finalData = {
      ...extractedDetails,
      fileSize: formatFileSize(selectedFile.size),
      fileType: selectedFile.type,
      pageCount: selectedFile.type === 'application/pdf' ? pdfPagePreviews.length || 1 : 1,
    };
    
    extractedPropertyData = finalData;
    
    aiProgress = 95;
    await new Promise(res => setTimeout(res, 100));
    
    currentAiStage = 'complete';
    aiProgress = 100;
    updateAiProcessingUI();
    
    // Initialize instruments from extracted data
    if (finalData.instrument) {
      instruments = [{
        id: Date.now().toString(),
        type: finalData.instrument,
        description: '',
        parties: {
          assignor: finalData.assignor || '',
          assignee: finalData.assignee || ''
        },
        registrationDetails: {
          serialNo: finalData.serialNo || '',
          page: finalData.page || '',
          vol: finalData.vol || '',
          regNo: finalData.regNo || ''
        },
        notes: ''
      }];
    }
    
    showExtractionResults();
    showToast('AI processing complete. Review extracted data.', 'success');
    
  } catch (err) {
    console.error('AI Property Processing Error:', err);
    showError(`AI Processing failed: ${err.message}`);
    currentAiStage = 'idle';
    aiProgress = 0;
    hideAiProcessing();
    showToast('AI processing failed.', 'error');
  }
}

async function extractTextFromPropertyDocumentPDF(file) {
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    let hasExtractableText = false;
    
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      
      if (pageText.trim().length > 0) {
        fullText += `--- Page ${i} ---\n${pageText}\n\n`;
        hasExtractableText = true;
      }
    }
    
    if (hasExtractableText && fullText.trim().length > 20) {
      aiProgress = Math.min(55, aiProgress + 40);
      updateAiProcessingUI();
      return fullText;
    }
    
    showToast('PDF has limited selectable text. Using OCR for all pages.', 'info');
    
    let ocrText = '';
    const totalPdfPagesForOcr = pdf.numPages;
    const ocrStartProgress = aiProgress;
    const ocrTotalProportion = 40;
    
    for (let i = 1; i <= totalPdfPagesForOcr; i++) {
      const progressWithinOcrStage = ((i - 1) / totalPdfPagesForOcr) * ocrTotalProportion;
      aiProgress = ocrStartProgress + progressWithinOcrStage;
      updateAiProcessingUI();
      
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      if (!context) throw new Error('Could not get canvas context for OCR');
      
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      await page.render({ canvasContext: context, viewport: viewport }).promise;
      
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      if (!blob) {
        ocrText += `--- Page ${i} (OCR) ---\nError creating image blob for OCR\n\n`;
        continue;
      }
      
      const imageUrl = URL.createObjectURL(blob);
      
      const { data: { text } } = await window.Tesseract.recognize(imageUrl, 'eng', {
        logger: (m) => {
          if (m.status === 'recognizing text') {
            const pageOcrProgress = m.progress * (ocrTotalProportion / totalPdfPagesForOcr);
            aiProgress = ocrStartProgress + progressWithinOcrStage + pageOcrProgress;
            updateAiProcessingUI();
          }
        }
      });
      
      URL.revokeObjectURL(imageUrl);
      ocrText += `--- Page ${i} (OCR) ---\n${text || 'No text found by OCR'}\n\n`;
    }
    
    aiProgress = Math.min(55, aiProgress + ocrTotalProportion);
    updateAiProcessingUI();
    return ocrText || `Scanned PDF: ${file.name}. No text found.`;
    
  } catch (error) {
    console.error('Error processing PDF:', error);
    aiProgress = Math.min(55, aiProgress + 40);
    updateAiProcessingUI();
    showToast(`Error processing PDF: ${error.message}`, 'error');
    return `Error processing PDF: ${error.message}`;
  }
}

async function extractTextFromPropertyDocumentImage(file) {
  try {
    const imageUrl = URL.createObjectURL(file);
    const ocrStartProgress = aiProgress;
    const ocrTotalProportion = 40;
    
    aiProgress = ocrStartProgress;
    updateAiProcessingUI();
    
    const { data: { text } } = await window.Tesseract.recognize(imageUrl, 'eng', {
      logger: (m) => {
        if (m.status === 'recognizing text') {
          aiProgress = ocrStartProgress + m.progress * ocrTotalProportion;
          updateAiProcessingUI();
        }
      }
    });
    
    URL.revokeObjectURL(imageUrl);
    aiProgress = Math.min(55, aiProgress + ocrTotalProportion);
    updateAiProcessingUI();
    return text || '';
    
  } catch (error) {
    console.error('Error during OCR on image:', error);
    aiProgress = Math.min(55, aiProgress + 40);
    updateAiProcessingUI();
    showToast(`Error during OCR: ${error.message}`, 'error');
    return '';
  }
}

function extractPropertyInstrumentDetails(text, fileName) {
  const cleanText = text
    .replace(/(\r\n|\n|\r)/gm, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  
  const data = {
    originalFileName: fileName,
    extractedText: text,
    confidence: 0,
    instruments: []
  };
  
  let foundFields = 0;
  
  // File number extraction
  const fileNoMatch = cleanText.match(/(?:File\s*No\.?|FILE\s*NUMBER)\s*:\s*([A-Z0-9/\s-]+)/i);
  if (fileNoMatch?.[1]) {
    data.fileNo = fileNoMatch[1].trim();
    const parts = data.fileNo.split(/[\s-]+/);
    if (parts.length > 1) {
      data.filePrefix = parts.slice(0, -1).join('-');
      data.fileSerialNo = parts.pop();
    } else {
      data.fileSerialNo = data.fileNo;
    }
    data.kangisFileNo = data.fileNo;
    data.fileNumberType = 'kangisFileNo';
    foundFields++;
  }
  
  // MLS File number
  const mlsFileNoMatch = cleanText.match(/(?:MLS\s*File\s*No\.?)\s*:\s*([A-Z0-9/\s-]+)/i);
  if (mlsFileNoMatch?.[1]) {
    data.mlsFileNo = mlsFileNoMatch[1].trim();
    foundFields++;
  }
  
  // Instrument type
  const instrumentMatch = cleanText.match(
    /(DEED\s+OF\s+ASSIGNMENT|CERTIFICATE\s+OF\s+OCCUPANCY|RIGHT\s+OF\s+OCCUPANCY|DEED\s+OF\s+MORTGAGE)/i
  );
  if (instrumentMatch?.[1]) {
    data.instrument = instrumentMatch[1].trim();
    foundFields++;
  }
  
  // Parties
  const assignorMatch = cleanText.match(
    /(?:ASSIGNOR|VENDOR|GRANTOR)\s*:\s*([A-Za-z\s.,'-]+)(?:Assignee|Purchaser|Grantee|Address)/i
  );
  if (assignorMatch?.[1]) {
    data.assignor = assignorMatch[1].trim().replace(/,\s*$/, '');
    foundFields++;
  }
  
  const assigneeMatch = cleanText.match(
    /(?:ASSIGNEE|PURCHASER|GRANTEE|HOLDER)\s*:\s*([A-Za-z\s.,'-]+)(?:Property|Address|Consideration)/i
  );
  if (assigneeMatch?.[1]) {
    data.assignee = assigneeMatch[1].trim().replace(/,\s*$/, '');
    foundFields++;
  }
  
  // Plot number
  const plotNoMatch = cleanText.match(/(?:Plot\s*No\.?|PLOT)\s*([A-Za-z0-9\s-]+)/i);
  if (plotNoMatch?.[1]) {
    data.plotNo = plotNoMatch[1].trim();
    foundFields++;
  }
  
  // LGA
  const lgaMatch = cleanText.match(/(?:LGA|Local\s*Government\s*Area)\s*:\s*([A-Za-z\s]+)/i);
  if (lgaMatch?.[1]) {
    data.lgsaOrCity = lgaMatch[1].trim();
    foundFields++;
  }
  
  // Registration details
  const regDetailsMatch = cleanText.match(
    /Registered\s+as\s+No\.?\s*(\d+)\s*\/\s*Page\s*(\d+)\s*\/\s*Volume\s*(\d+)/i
  );
  if (regDetailsMatch) {
    data.serialNo = regDetailsMatch[1];
    data.page = regDetailsMatch[2];
    data.vol = regDetailsMatch[3];
    data.regNo = `${data.serialNo}/${data.page}/${data.vol}`;
    foundFields += 3;
  }
  
  // Description
  const descriptionMatch = cleanText.match(
    /(?:Property\s*Description|ALL\s*THAT\s*parcel\s*of\s*land)\s*:\s*([^.]+)/i
  );
  if (descriptionMatch?.[1]) {
    data.description = descriptionMatch[1].trim();
    foundFields++;
  }
  
  data.confidence = Math.min(100, Math.round((foundFields / 10) * 100));
  data.extractionStatus = data.confidence > 50 ? 'Partially Extracted' : 
                         data.confidence > 20 ? 'Low Confidence' : 'Extraction Failed';
  
  return data;
}

function analyzeTextForKeywords(text) {
  const findings = {};
  const keywords = [
    'POWER OF ATTORNEY',
    'IRREVOCABLE POWER OF ATTORNEY',
    'DEED OF MORTGAGE',
    'TRIPARTITE MORTGAGE',
    'DEED OF ASSIGNMENT',
    'DEED OF LEASE',
    'DEED OF SUB-LEASE',
    'DEED OF SUB-UNDER LEASE',
    'DEED OF SUB-DIVISION',
    'DEED OF MERGER',
    'DEED OF SURRENDER',
    'DEED OF ASSENT',
    'DEED OF RELEASE',
    'CERTIFICATE OF OCCUPANCY',
    'C OF O',
    'RIGHT OF OCCUPANCY',
    'R OF O',
    'SURVEY PLAN'
  ];
  
  const pageMarkerRegex = /--- Page (\d+)(?:\s*$$OCR$$)?\s*---/gi;
  const pageContents = [];
  const matches = Array.from(text.matchAll(pageMarkerRegex));
  
  if (matches.length > 0) {
    matches.forEach((currentMatch, i) => {
      const pageNum = parseInt(currentMatch[1], 10);
      const contentStartIndex = currentMatch.index + currentMatch[0].length;
      let contentEndIndex;
      
      if (i + 1 < matches.length) {
        contentEndIndex = matches[i + 1].index;
      } else {
        contentEndIndex = text.length;
      }
      
      const pageContent = text.substring(contentStartIndex, contentEndIndex);
      pageContents.push({ content: pageContent, pageNum });
    });
  } else if (text.trim().length > 0) {
    pageContents.push({ content: text, pageNum: 1 });
  }
  
  pageContents.forEach(({ content, pageNum }) => {
    const upperPageContent = content.toUpperCase();
    keywords.forEach(keyword => {
      if (upperPageContent.includes(keyword)) {
        if (!findings[keyword]) {
          findings[keyword] = [];
        }
        if (!findings[keyword].includes(pageNum)) {
          findings[keyword].push(pageNum);
        }
      }
    });
  });
  
  return findings;
}

function showAiProcessing() {
  document.getElementById('ai-processing').classList.remove('hidden');
}

function hideAiProcessing() {
  document.getElementById('ai-processing').classList.add('hidden');
}

function updateAiProcessingUI() {
  // Update progress bar
  document.getElementById('ai-progress-text').textContent = `${aiProgress}% Complete`;
  document.getElementById('ai-progress-bar').style.width = `${aiProgress}%`;
  
  // Update stage indicators
  const stages = ['initializing', 'ocr', 'layoutAnalysis', 'dataExtraction', 'dataAssembly', 'complete'];
  const currentStageIndex = stages.indexOf(currentAiStage);
  
  document.querySelectorAll('.stage-indicator').forEach((indicator, index) => {
    const circle = indicator.querySelector('.w-4');
    const text = indicator.querySelector('.text-xs');
    
    if (index < currentStageIndex) {
      // Completed stage
      circle.className = 'w-4 h-4 rounded-full bg-blue-500 mb-1';
      text.className = 'text-xs font-medium text-blue-600';
    } else if (index === currentStageIndex) {
      // Current stage
      circle.className = 'w-4 h-4 rounded-full bg-blue-500 ring-4 ring-blue-100 animate-pulse mb-1';
      text.className = 'text-xs font-bold text-blue-700';
    } else {
      // Future stage
      circle.className = 'w-4 h-4 rounded-full bg-gray-300 mb-1';
      text.className = 'text-xs text-gray-500';
    }
  });
  
  // Update stage description
  updateStageDescription();
}

function updateStageDescription() {
  const stageTitle = document.getElementById('ai-stage-title');
  const stageDescription = document.getElementById('ai-stage-description');
  const stageIcon = document.getElementById('ai-stage-icon');
  
  const stageInfo = {
    'initializing': {
      title: 'Initializing',
      description: 'Initializing AI for property document analysis...',
      icon: 'brain'
    },
    'ocr': {
      title: 'OCR',
      description: 'Performing OCR to extract text from the document...',
      icon: 'file-digit'
    },
    'layoutAnalysis': {
      title: 'Layout Analysis',
      description: 'Analyzing document structure...',
      icon: 'file-search'
    },
    'dataExtraction': {
      title: 'Data Extraction',
      description: 'Extracting key property details: File No, Parties, Plot, Instrument...',
      icon: 'layers'
    },
    'dataAssembly': {
      title: 'Data Assembly',
      description: 'Structuring extracted information...',
      icon: 'zap'
    },
    'complete': {
      title: 'Complete',
      description: 'Property document analysis complete! Review data in the form.',
      icon: 'sparkles'
    }
  };
  
  const info = stageInfo[currentAiStage] || stageInfo['initializing'];
  
  stageTitle.textContent = `Current Stage: ${info.title}`;
  stageDescription.textContent = info.description;
  stageIcon.setAttribute('data-lucide', info.icon);
  
  // Re-initialize Lucide icons
  lucide.createIcons();
}

function showExtractionResults() {
  // Show keyword findings
  const instrumentsFound = Object.keys(keywordFindings).filter(keyword => keywordFindings[keyword].length > 0);
  if (instrumentsFound.length > 0) {
    const keywordCard = document.getElementById('keyword-findings');
    const description = document.getElementById('keyword-findings-description');
    const list = document.getElementById('keyword-findings-list');
    
    description.textContent = `This file contains ${instrumentsFound.length} ${instrumentsFound.length === 1 ? 'instrument' : 'instruments'}:`;
    
    instrumentsFound.sort();
    list.innerHTML = instrumentsFound.map(instrument => `
      <li class="flex items-center text-sm">
        <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
        <span class="font-medium text-gray-800">${instrument}</span>
      </li>
    `).join('');
    
    keywordCard.classList.remove('hidden');
  }
  
  // Show raw text
  if (rawExtractedText) {
    const rawTextCard = document.getElementById('raw-text-card');
    const textarea = document.getElementById('raw-text-textarea');
    textarea.value = rawExtractedText;
    rawTextCard.classList.remove('hidden');
  }
  
  // Show extracted details
  if (extractedPropertyData) {
    populatePropertyForm();
    renderInstruments();
    document.getElementById('extracted-details').classList.remove('hidden');
  }
}

function populatePropertyForm() {
  if (!extractedPropertyData) return;
  
  const data = extractedPropertyData;
  
  // Set confidence display
  document.getElementById('extraction-confidence').textContent = 
    `Review the details extracted by the AI. Add or modify instruments as needed, then save the record. Confidence: ${data.confidence}% (${data.extractionStatus})`;
  
  // Populate form fields
  if (data.fileNumberType) {
    document.getElementById('file-number-type').value = data.fileNumberType;
  }
  if (data.filePrefix) {
    document.getElementById('file-prefix').value = data.filePrefix;
  }
  if (data.fileSerialNo) {
    document.getElementById('file-serial-no').value = data.fileSerialNo;
  }
  if (data.fileNo) {
    document.getElementById('complete-file-no').value = data.fileNo;
  }
  if (data.plotNo) {
    document.getElementById('plot-no').value = data.plotNo;
  }
  if (data.lgsaOrCity) {
    document.getElementById('lga-city').value = data.lgsaOrCity;
  }
  if (data.description) {
    document.getElementById('property-description').value = data.description;
  }
}

function updateCompleteFileNo() {
  const prefix = document.getElementById('file-prefix').value.trim();
  const serialNo = document.getElementById('file-serial-no').value.trim();
  const completeField = document.getElementById('complete-file-no');
  
  if (prefix && serialNo) {
    completeField.value = `${prefix}/${serialNo}`;
  } else if (serialNo) {
    completeField.value = serialNo;
  } else {
    completeField.value = '';
  }
}

function addInstrument() {
  const newInstrument = {
    id: Date.now().toString(),
    type: extractedPropertyData?.instrument || '',
    description: '',
    parties: {
      assignor: extractedPropertyData?.assignor || '',
      assignee: extractedPropertyData?.assignee || ''
    },
    registrationDetails: {
      serialNo: extractedPropertyData?.serialNo || '',
      page: extractedPropertyData?.page || '',
      vol: extractedPropertyData?.vol || '',
      regNo: extractedPropertyData?.regNo || ''
    },
    notes: ''
  };
  
  instruments.push(newInstrument);
  editingInstrumentId = newInstrument.id;
  renderInstruments();
}

function removeInstrument(id) {
  instruments = instruments.filter(inst => inst.id !== id);
  if (editingInstrumentId === id) {
    editingInstrumentId = null;
  }
  renderInstruments();
}

function toggleInstrumentEdit(id) {
  editingInstrumentId = editingInstrumentId === id ? null : id;
  renderInstruments();
}

function updateInstrument(id, field, value) {
  const instrument = instruments.find(inst => inst.id === id);
  if (instrument) {
    if (field.includes('.')) {
      const [parent, child] = field.split('.');
      if (!instrument[parent]) instrument[parent] = {};
      instrument[parent][child] = value;
      
      // Auto-generate regNo when all parts are available
      if (parent === 'registrationDetails') {
        const details = instrument.registrationDetails;
        if (details.serialNo && details.page && details.vol) {
          details.regNo = `${details.serialNo}/${details.page}/${details.vol}`;
        }
      }
    } else {
      instrument[field] = value;
    }
    renderInstruments();
  }
}

function renderInstruments() {
  const container = document.getElementById('instruments-list');
  const noInstruments = document.getElementById('no-instruments');
  
  if (instruments.length === 0) {
    container.innerHTML = '';
    noInstruments.classList.remove('hidden');
    return;
  }
  
  noInstruments.classList.add('hidden');
  
  const instrumentTypes = [
    'DEED OF ASSIGNMENT',
    'CERTIFICATE OF OCCUPANCY',
    'RIGHT OF OCCUPANCY',
    'DEED OF MORTGAGE',
    'TRIPARTITE MORTGAGE',
    'DEED OF LEASE',
    'DEED OF SUB-LEASE',
    'DEED OF SUB-UNDER LEASE',
    'DEED OF SURRENDER',
    'DEED OF ASSENT',
    'DEED OF RELEASE',
    'POWER OF ATTORNEY',
    'IRREVOCABLE POWER OF ATTORNEY',
    'DEED OF SUB-DIVISION',
    'DEED OF MERGER',
    'SURVEY PLAN',
    'OTHER'
  ];
  
  container.innerHTML = instruments.map((instrument, index) => {
    const isEditing = editingInstrumentId === instrument.id;
    
    return `
      <div class="bg-white rounded-lg border instrument-card ${isEditing ? 'editing' : ''}">
        <div class="p-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium">Instrument #${index + 1}</span>
              ${instrument.type ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${instrument.type}</span>` : ''}
            </div>
            <div class="flex items-center gap-1">
              <button onclick="toggleInstrumentEdit('${instrument.id}')" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-2 py-1 transition-all cursor-pointer bg-transparent text-gray-700 hover:bg-gray-100">
                <i data-lucide="edit-3" class="h-4 w-4"></i>
              </button>
              <button onclick="removeInstrument('${instrument.id}')" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-2 py-1 transition-all cursor-pointer bg-transparent text-red-600 hover:bg-red-50">
                <i data-lucide="trash-2" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </div>
        
        ${isEditing ? `
          <div class="p-4 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-xs font-medium text-gray-700">Instrument Type</label>
                <select onchange="updateInstrument('${instrument.id}', 'type', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10">
                  <option value="">Select instrument type</option>
                  ${instrumentTypes.map(type => `
                    <option value="${type}" ${instrument.type === type ? 'selected' : ''}>${type}</option>
                  `).join('')}
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-xs font-medium text-gray-700">Description</label>
                <input
                  type="text"
                  value="${instrument.description || ''}"
                  onchange="updateInstrument('${instrument.id}', 'description', this.value)"
                  placeholder="Brief description"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10"
                />
              </div>
            </div>
            
            <!-- Parties Section -->
            <div class="space-y-2">
              <label class="text-xs font-medium text-gray-700">Parties Involved</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-gray-50 rounded-md">
                <div class="space-y-1">
                  <label class="text-xs text-gray-600">Assignor/Grantor</label>
                  <input
                    type="text"
                    value="${instrument.parties?.assignor || instrument.parties?.grantor || ''}"
                    onchange="updateInstrument('${instrument.id}', 'parties.assignor', this.value)"
                    placeholder="Name of assignor/grantor"
                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-gray-600">Assignee/Grantee</label>
                  <input
                    type="text"
                    value="${instrument.parties?.assignee || instrument.parties?.grantee || ''}"
                    onchange="updateInstrument('${instrument.id}', 'parties.assignee', this.value)"
                    placeholder="Name of assignee/grantee"
                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                </div>
                ${instrument.type?.includes('MORTGAGE') ? `
                  <div class="space-y-1">
                    <label class="text-xs text-gray-600">Mortgagor</label>
                    <input
                      type="text"
                      value="${instrument.parties?.mortgagor || ''}"
                      onchange="updateInstrument('${instrument.id}', 'parties.mortgagor', this.value)"
                      placeholder="Name of mortgagor"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    />
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs text-gray-600">Mortgagee</label>
                    <input
                      type="text"
                      value="${instrument.parties?.mortgagee || ''}"
                      onchange="updateInstrument('${instrument.id}', 'parties.mortgagee', this.value)"
                      placeholder="Name of mortgagee"
                      class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                    />
                  </div>
                ` : ''}
              </div>
            </div>
            
            <!-- Registration Details Section -->
            <div class="space-y-2">
              <label class="text-xs font-medium text-gray-700">Registration Details</label>
              <div class="grid grid-cols-3 gap-3 p-3 bg-gray-50 rounded-md">
                <div class="space-y-1">
                  <label class="text-xs text-gray-600">Serial No.</label>
                  <input
                    type="text"
                    value="${instrument.registrationDetails?.serialNo || ''}"
                    onchange="updateInstrument('${instrument.id}', 'registrationDetails.serialNo', this.value)"
                    placeholder="e.g. 1"
                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-gray-600">Page</label>
                  <input
                    type="text"
                    value="${instrument.registrationDetails?.page || ''}"
                    onchange="updateInstrument('${instrument.id}', 'registrationDetails.page', this.value)"
                    placeholder="e.g. 1"
                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                </div>
                <div class="space-y-1">
                  <label class="text-xs text-gray-600">Volume</label>
                  <input
                    type="text"
                    value="${instrument.registrationDetails?.vol || ''}"
                    onchange="updateInstrument('${instrument.id}', 'registrationDetails.vol', this.value)"
                    placeholder="e.g. 2"
                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                </div>
              </div>
              ${instrument.registrationDetails?.regNo ? `
                <div class="mt-2 p-2 bg-green-50 border border-green-100 rounded-md">
                  <div class="flex items-center justify-between">
                    <span class="text-xs text-green-700">REG NO:</span>
                    <span class="text-sm font-medium text-green-800">${instrument.registrationDetails.regNo}</span>
                  </div>
                </div>
              ` : ''}
            </div>
            
            <!-- Notes Section -->
            <div class="space-y-2">
              <label class="text-xs font-medium text-gray-700">Additional Notes</label>
              <textarea
                value="${instrument.notes || ''}"
                onchange="updateInstrument('${instrument.id}', 'notes', this.value)"
                placeholder="Any additional notes about this instrument..."
                rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm transition-all focus:outline-none focus:border-blue-600 focus:ring-2 focus:ring-blue-600/10"
              >${instrument.notes || ''}</textarea>
            </div>
            
            <div class="flex justify-end pt-2">
              <button onclick="toggleInstrumentEdit('${instrument.id}')" class="inline-flex items-center justify-center rounded-md font-medium text-sm px-3 py-1 transition-all cursor-pointer bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50">
                Done Editing
              </button>
            </div>
          </div>
        ` : `
          <div class="p-4">
            <div class="text-sm text-gray-600 space-y-1">
              ${instrument.description ? `
                <p><span class="font-medium">Description:</span> ${instrument.description}</p>
              ` : ''}
              ${(instrument.parties?.assignor || instrument.parties?.grantor) ? `
                <p><span class="font-medium">From:</span> ${instrument.parties.assignor || instrument.parties.grantor}</p>
              ` : ''}
              ${(instrument.parties?.assignee || instrument.parties?.grantee) ? `
                <p><span class="font-medium">To:</span> ${instrument.parties.assignee || instrument.parties.grantee}</p>
              ` : ''}
              ${instrument.registrationDetails?.regNo ? `
                <p><span class="font-medium">Reg No:</span> ${instrument.registrationDetails.regNo}</p>
              ` : ''}
              ${instrument.notes ? `
                <p><span class="font-medium">Notes:</span> ${instrument.notes}</p>
              ` : ''}
            </div>
          </div>
        `}
      </div>
    `;
  }).join('');
  
  // Re-initialize Lucide icons
  lucide.createIcons();
}

function toggleRawText() {
  const content = document.getElementById('raw-text-content');
  const button = document.getElementById('toggle-raw-text');
  const icon = button.querySelector('i');
  
  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    icon.setAttribute('data-lucide', 'chevron-down');
    button.innerHTML = '<i data-lucide="chevron-down" class="h-4 w-4"></i> Show';
  } else {
    content.classList.add('expanded');
    icon.setAttribute('data-lucide', 'chevron-up');
    button.innerHTML = '<i data-lucide="chevron-up" class="h-4 w-4"></i> Hide';
  }
  
  lucide.createIcons();
}

function handleSaveRecord() {
  if (!extractedPropertyData) return;
  
  // Collect form data
  const formData = {
    ...extractedPropertyData,
    fileNumberType: document.getElementById('file-number-type').value,
    filePrefix: document.getElementById('file-prefix').value,
    fileSerialNo: document.getElementById('file-serial-no').value,
    fileNo: document.getElementById('complete-file-no').value,
    plotNo: document.getElementById('plot-no').value,
    lgsaOrCity: document.getElementById('lga-city').value,
    description: document.getElementById('property-description').value,
    instruments: instruments
  };
  
  // Here you would typically save to your database
  console.log('Saving property record:', formData);
  showToast('Property record saved successfully!', 'success');
  
  // Optionally reset the form after saving
  // resetState();
}

function resetState() {
  selectedFile = null;
  previewUrl = null;
  pdfPagePreviews = [];
  currentPdfPreviewPageIdx = 0;
  rawExtractedText = '';
  extractedPropertyData = null;
  keywordFindings = {};
  currentAiStage = 'idle';
  aiProgress = 0;
  instruments = [];
  editingInstrumentId = null;
  
  // Reset file input
  document.getElementById('file-input').value = '';
  document.getElementById('file-upload-text').textContent = 'Click to select a file';
  
  // Hide all sections
  hideError();
  document.getElementById('image-preview').classList.add('hidden');
  document.getElementById('pdf-preview').classList.add('hidden');
  hideAiProcessing();
  document.getElementById('keyword-findings').classList.add('hidden');
  document.getElementById('raw-text-card').classList.add('hidden');
  document.getElementById('extracted-details').classList.add('hidden');
  
  updateUI();
}

function resetExtractionState() {
  rawExtractedText = '';
  extractedPropertyData = null;
  keywordFindings = {};
  currentAiStage = 'idle';
  aiProgress = 0;
  instruments = [];
  editingInstrumentId = null;
  
  hideAiProcessing();
  document.getElementById('keyword-findings').classList.add('hidden');
  document.getElementById('raw-text-card').classList.add('hidden');
  document.getElementById('extracted-details').classList.add('hidden');
}

function resetFileState() {
  selectedFile = null;
  previewUrl = null;
  pdfPagePreviews = [];
  currentPdfPreviewPageIdx = 0;
  
  document.getElementById('file-input').value = '';
  document.getElementById('file-upload-text').textContent = 'Click to select a file';
  document.getElementById('image-preview').classList.add('hidden');
  document.getElementById('pdf-preview').classList.add('hidden');
}

function updateUI() {
  const startBtn = document.getElementById('start-ai-btn');
  const resetBtn = document.getElementById('reset-btn');
  
  // Update start button state
  if (selectedFile && (currentAiStage === 'idle' || currentAiStage === 'complete')) {
    startBtn.disabled = false;
    startBtn.innerHTML = currentAiStage === 'complete' ? 
      '<i data-lucide="wand-2" class="mr-2 h-4 w-4"></i>Re-process with AI' :
      '<i data-lucide="wand-2" class="mr-2 h-4 w-4"></i>Extract Data with AI';
  } else if (currentAiStage !== 'idle' && currentAiStage !== 'complete') {
    startBtn.disabled = true;
    startBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Processing...';
  } else {
    startBtn.disabled = true;
    startBtn.innerHTML = '<i data-lucide="wand-2" class="mr-2 h-4 w-4"></i>Extract Data with AI';
  }
  
  // Update reset button visibility
  if (currentAiStage !== 'idle' || selectedFile) {
    resetBtn.classList.remove('hidden');
  } else {
    resetBtn.classList.add('hidden');
  }
  
  // Re-initialize Lucide icons
  lucide.createIcons();
}

function showError(message) {
  const errorAlert = document.getElementById('error-alert');
  const errorMessage = document.getElementById('error-message');
  errorMessage.textContent = message;
  errorAlert.classList.remove('hidden');
  lucide.createIcons();
}

function hideError() {
  document.getElementById('error-alert').classList.add('hidden');
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showToast(message, type = 'info') {
  const toastContainer = document.getElementById('toast-container');
  const toastId = `toast-${Date.now()}`;
  
  const typeClasses = {
    success: 'bg-green-600 text-white',
    error: 'bg-red-600 text-white',
    warning: 'bg-yellow-600 text-white',
    info: 'bg-blue-600 text-white'
  };
  
  const toast = document.createElement('div');
  toast.id = toastId;
  toast.className = `${typeClasses[type]} px-4 py-2 rounded-md shadow-lg flex items-center gap-2 transform translate-x-full transition-transform duration-300`;
  toast.innerHTML = `
    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : type === 'warning' ? 'alert-triangle' : 'info'}" class="h-4 w-4"></i>
    <span>${message}</span>
    <button onclick="removeToast('${toastId}')" class="ml-2 hover:bg-black/20 rounded p-1">
      <i data-lucide="x" class="h-3 w-3"></i>
    </button>
  `;
  
  toastContainer.appendChild(toast);
  lucide.createIcons();
  
  // Animate in
  setTimeout(() => {
    toast.classList.remove('translate-x-full');
  }, 100);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    removeToast(toastId);
  }, 5000);
}

function removeToast(toastId) {
  const toast = document.getElementById(toastId);
  if (toast) {
    toast.classList.add('translate-x-full');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }
}
</script>
</body>
</html>
