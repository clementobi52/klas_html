<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload - EDMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
      .lucide {
        width: 1em;
        height: 1em;
        display: inline-block;
        vertical-align: middle;
      }
      .document-preview {
        max-height: 400px;
        overflow-y: auto;
      }
      .pdf-page {
        margin-bottom: 10px;
        border: 1px solid #e5e7eb;
      }
      /* Custom checkbox styling */
      .checkbox-container {
        display: block;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }
      .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 20px;
        width: 20px;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .checkbox-container:hover input ~ .checkmark {
        background-color: #ccc;
      }
      .checkbox-container input:checked ~ .checkmark {
        background-color: #3b82f6;
        border-color: #3b82f6;
      }
      .checkmark:after {
        content: "";
        position: absolute;
        display: none;
      }
      .checkbox-container input:checked ~ .checkmark:after {
        display: block;
      }
      .checkbox-container .checkmark:after {
        left: 7px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        -webkit-transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        transform: rotate(45deg);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto py-6 space-y-6 px-4">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">File Upload</h1>
        <p class="text-gray-600 mt-2">Upload digital files to the registry</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-lg border shadow-sm">
          <div class="p-4 pb-2">
            <h3 class="text-sm font-medium text-gray-600">Today's Uploads</h3>
          </div>
          <div class="p-4 pt-0">
            <div class="text-2xl font-bold" id="todaysUploads">0</div>
            <p class="text-xs text-gray-500 mt-1">Files uploaded today</p>
          </div>
        </div>
        <div class="bg-white rounded-lg border shadow-sm">
          <div class="p-4 pb-2">
            <h3 class="text-sm font-medium text-gray-600">Pending Indexing</h3>
          </div>
          <div class="p-4 pt-0">
            <div class="text-2xl font-bold" id="pendingIndexing">0</div>
            <p class="text-xs text-gray-500 mt-1">
              Files waiting to be indexed
            </p>
          </div>
        </div>
        <div class="bg-white rounded-lg border shadow-sm">
          <div class="p-4 pb-2">
            <h3 class="text-sm font-medium text-gray-600">Upload Status</h3>
          </div>
          <div class="p-4 pt-0">
            <div class="text-2xl font-bold flex items-center">
              <span id="uploadStatusText">Ready</span>
              <span
                class="ml-2 px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800"
                id="uploadStatusBadge"
                >Ready</span
              >
            </div>
            <p class="text-xs text-gray-500 mt-1">Current upload status</p>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="w-full">
        <div class="border-b border-gray-200">
          <nav class="-mb-px flex space-x-8">
            <button
              class="tab-button active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"
              data-tab="upload"
            >
              Upload Files
            </button>
            <button
              class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="uploaded-files"
            >
              Uploaded Files
            </button>
          </nav>
        </div>

        <!-- Upload Tab Content -->
        <div id="upload-tab" class="tab-content mt-6">
          <div class="bg-white rounded-lg border shadow-sm">
            <div class="p-6 border-b">
              <h3 class="text-lg font-semibold">Upload Files</h3>
              <p class="text-gray-600 text-sm mt-1">
                Upload digital files to the registry
              </p>
            </div>
            <div class="p-6">
              <div class="space-y-6">
                <!-- Upload Area -->
                <div
                  id="upload-area"
                  class="rounded-md border-2 border-dashed border-gray-300 p-8 text-center hover:border-blue-400 transition-colors cursor-pointer"
                >
                  <div
                    class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-gray-100"
                  >
                    <svg
                      class="h-6 w-6 text-gray-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      ></path>
                    </svg>
                  </div>
                  <h3 class="mb-2 text-lg font-medium">
                    Drag and drop files here
                  </h3>
                  <p class="mb-4 text-sm text-gray-500">
                    or click to browse files on your computer
                  </p>
                  <input
                    type="file"
                    multiple
                    accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.webp"
                    class="hidden"
                    id="file-upload"
                  />
                  <button
                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    onclick="document.getElementById('file-upload').click()"
                  >
                    <svg
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      ></path>
                    </svg>
                    Browse Files
                  </button>
                  <p class="text-xs text-gray-500 mt-2">
                    Supported formats: PDF, JPG, PNG, GIF, BMP, TIFF, WebP (OCR
                    enabled for scanned documents)
                  </p>
                </div>

                <!-- Selected Files -->
                <div
                  id="selected-files"
                  class="hidden rounded-md border divide-y"
                >
                  <div class="p-3 bg-gray-50 flex justify-between items-center">
                    <span class="font-medium" id="selected-count"
                      >0 files selected</span
                    >
                    <button
                      class="text-sm text-gray-600 hover:text-gray-800"
                      onclick="clearAllFiles()"
                    >
                      Clear All
                    </button>
                  </div>
                  <div id="selected-files-list"></div>
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="hidden space-y-2">
                  <div class="flex justify-between text-sm">
                    <span id="upload-progress-text">Uploading files...</span>
                    <span id="upload-progress-percent">0%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div
                      class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                      id="upload-progress-bar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                  <button
                    id="start-upload-btn"
                    class="hidden inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    onclick="startUpload()"
                  >
                    <svg
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      ></path>
                    </svg>
                    Start Upload & Analysis
                  </button>
                  <button
                    id="cancel-upload-btn"
                    class="hidden inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
                    onclick="cancelUpload()"
                  >
                    <svg
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                    </svg>
                    Cancel
                  </button>
                  <button
                    id="upload-more-btn"
                    class="hidden inline-flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
                    onclick="resetUpload()"
                  >
                    <svg
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      ></path>
                    </svg>
                    Upload More
                  </button>
                  <button
                    id="view-files-btn"
                    class="hidden inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                    onclick="switchToUploadedFiles()"
                  >
                    <svg
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                    </svg>
                    View Uploaded Files
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Uploaded Files Tab Content -->
        <div id="uploaded-files-tab" class="tab-content mt-6 hidden">
          <div class="bg-white rounded-lg border shadow-sm">
            <div class="p-6 border-b">
              <div
                class="flex flex-col md:flex-row md:items-center justify-between gap-4"
              >
                <div>
                  <h3 class="text-lg font-semibold">Uploaded Files</h3>
                  <p class="text-gray-600 text-sm mt-1">
                    Recently uploaded files ready for processing
                  </p>
                </div>
                <div class="relative w-full md:w-64">
                  <svg
                    class="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    ></path>
                  </svg>
                  <input
                    type="search"
                    placeholder="Search files..."
                    class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    id="file-search"
                  />
                </div>
              </div>
            </div>
            <div class="overflow-x-auto">
              <div id="uploaded-files-list">
                <!-- Content will be populated by JavaScript -->
              </div>
            </div>
            <!-- Updated Uploaded Files Footer with Selected Files Action -->
            <div
              id="uploaded-files-footer"
              class="hidden border-t p-6 flex justify-between items-center"
            >
              <div class="flex items-center gap-4">
                <button
                  class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
                  onclick="switchToUpload()"
                >
                  Upload More
                </button>
                <span
                  id="selected-count-display"
                  class="text-sm text-gray-600 hidden"
                >
                  <span id="selected-files-count">0</span> files selected
                </span>
              </div>
              <div class="flex gap-3">
                <button
                  id="send-selected-btn"
                  class="hidden px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                  onclick="sendSelectedToIndexing()"
                >
                  Send Selected to Indexing
                </button>
                <button
                  id="send-all-btn"
                  class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                  onclick="sendToIndexing()"
                >
                  Send All to Indexing
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Processing Section -->
      <div
        id="ai-processing"
        class="hidden mt-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg"
      >
        <div class="flex items-center gap-2 mb-4">
          <div class="p-2 bg-blue-100 rounded-full">
            <svg
              class="h-5 w-5 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
              ></path>
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-blue-900">AI Document Analysis</h3>
            <p class="text-sm text-blue-700">
              Extracting metadata for File Indexing Assistant
            </p>
          </div>
        </div>
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Processing Progress</span>
            <span class="text-sm font-medium" id="ai-progress-percent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              id="ai-progress-bar"
              style="width: 0%"
            ></div>
          </div>
          <div class="grid grid-cols-4 gap-2 mt-4" id="ai-stages">
            <div
              class="text-center p-2 rounded bg-gray-100 text-gray-500"
              data-stage="analyzing"
            >
              <svg
                class="h-4 w-4 mx-auto mb-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
              <div class="text-xs font-medium">Analyzing</div>
            </div>
            <div
              class="text-center p-2 rounded bg-gray-100 text-gray-500"
              data-stage="extracting"
            >
              <svg
                class="h-4 w-4 mx-auto mb-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                ></path>
              </svg>
              <div class="text-xs font-medium">Extracting</div>
            </div>
            <div
              class="text-center p-2 rounded bg-gray-100 text-gray-500"
              data-stage="creating"
            >
              <svg
                class="h-4 w-4 mx-auto mb-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                ></path>
              </svg>
              <div class="text-xs font-medium">Creating</div>
            </div>
            <div
              class="text-center p-2 rounded bg-gray-100 text-gray-500"
              data-stage="complete"
            >
              <svg
                class="h-4 w-4 mx-auto mb-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <div class="text-xs font-medium">Complete</div>
            </div>
          </div>

          <!-- Analysis Results -->
          <div
            id="analysis-results"
            class="hidden mt-4 p-4 bg-white rounded-lg border shadow-sm"
          >
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-gray-900">
                Document Analysis Results
              </h4>
              <span
                class="px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800 border border-green-200"
                id="files-processed"
                >0 files processed</span
              >
            </div>
            <div id="metadata-results" class="space-y-6"></div>

            <!-- Summary and Actions -->
            <div
              class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200"
            >
              <div class="flex items-center justify-between">
                <div>
                  <h5 class="font-semibold text-gray-900 mb-1">
                    Analysis Complete
                  </h5>
                  <p class="text-sm text-gray-600">
                    All documents have been processed and are ready to be added
                    to the File Indexing Assistant.
                  </p>
                </div>
                <div class="flex gap-3">
                  <button
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
                    onclick="resetUpload()"
                  >
                    Cancel
                  </button>
                  <button
                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    onclick="createIndexingEntries()"
                  >
                    <svg
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
                      ></path>
                    </svg>
                    Create in File Indexing Assistant
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- OCR Processing Modal -->
    <div
      id="ocr-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold mb-4">Document Text Extraction</h3>
        <div class="space-y-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-blue-100 rounded-full">
              <svg
                class="h-5 w-5 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
            </div>
            <div>
              <h4 class="font-medium">Extracting Text from Documents</h4>
              <p class="text-sm text-gray-600" id="ocr-current-file">
                Processing documents...
              </p>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span>Extraction Progress</span>
              <span id="ocr-progress-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div
                class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                id="ocr-progress-bar"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div class="p-3 bg-gray-100 rounded text-sm">
            <p class="font-medium mb-1">Processing:</p>
            <ul class="space-y-1 text-gray-600">
              <li>• Reading PDF pages</li>
              <li>• Converting pages to images</li>
              <li>• Running OCR on each page</li>
              <li>• Analyzing document structure</li>
              <li>• Searching for metadata patterns</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Metadata Modal -->
    <div
      id="metadata-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold" id="metadata-modal-title">
            Edit Document Metadata
          </h3>
          <button
            class="text-gray-400 hover:text-gray-600"
            onclick="closeMetadataModal()"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h4 class="font-medium mb-2">Metadata Fields</h4>
            <form id="metadata-form" class="space-y-4">
              <!-- Form fields will be inserted here by JavaScript -->
            </form>
          </div>
          <div>
            <h4 class="font-medium mb-2">Document Preview</h4>
            <div
              id="metadata-preview-content"
              class="document-preview border rounded-lg p-4 bg-gray-50"
            >
              <div id="pdf-preview-wrapper" class="relative hidden">
                <canvas
                  id="pdf-preview-canvas"
                  class="w-full h-auto border rounded-lg"
                ></canvas>
                <p
                  id="pdf-loading-placeholder"
                  class="text-gray-500 text-center py-8 hidden"
                >
                  Loading PDF preview...
                </p>
                <div
                  id="pdf-navigation-controls"
                  class="flex justify-between items-center mt-4 hidden"
                >
                  <button
                    id="prev-page-btn"
                    class="px-3 py-1 bg-gray-200 rounded text-gray-700 hover:bg-gray-300 disabled:opacity-50"
                    onclick="goToPreviousPage()"
                    disabled
                  >
                    Previous
                  </button>
                  <span
                    id="page-info"
                    class="text-sm font-medium text-gray-700"
                  ></span>
                  <button
                    id="next-page-btn"
                    class="px-3 py-1 bg-gray-200 rounded text-gray-700 hover:bg-gray-300 disabled:opacity-50"
                    onclick="goToNextPage()"
                    disabled
                  >
                    Next
                  </button>
                </div>
              </div>
              <div id="image-preview-wrapper" class="hidden">
                <img
                  id="image-preview-img"
                  src="/placeholder.svg"
                  alt="Document preview"
                  class="max-w-full h-auto border rounded"
                />
                <p
                  id="image-loading-placeholder"
                  class="text-gray-500 text-center py-8 hidden"
                >
                  Loading image preview...
                </p>
              </div>
              <p id="unsupported-preview-message" class="text-gray-500 hidden">
                Preview not available for this file type
              </p>
            </div>
            <h4 class="font-medium mb-2 mt-4">Extracted Text</h4>
            <div class="document-preview border rounded-lg p-4 bg-white">
              <pre
                id="metadata-extracted-text-preview"
                class="text-xs whitespace-pre-wrap text-gray-700"
              ></pre>
            </div>
          </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button
            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
            onclick="closeMetadataModal()"
          >
            Cancel
          </button>
          <button
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
            onclick="saveMetadata(event)"
          >
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let uploadStatus = "idle";
      let uploadProgress = 0;
      let selectedFiles = [];
      let uploadedFiles = [];
      let aiProcessingStage = "idle";
      let aiProgress = 0;
      let extractedMetadata = {}; // Now keyed by uploadedFile.id
      let currentEditingFile = null;
      let ocrProgress = 0;
      let filteredFiles = []; // For search functionality
      let currentPDFDocument = null; // Stores the PDFDocumentProxy object for the currently opened PDF in the modal
      let currentPageNumber = 1; // Stores the current page number being viewed in the PDF preview
      let selectedFileIds = []; // Stores IDs of selected files in the uploaded files table

      // Initialize PDF.js worker
      if (typeof pdfjsLib !== "undefined") {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }

      // Initialize the page when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
      });

      function initializePage() {
        // Set up event listeners
        setupEventListeners();

        // Initialize displays
        updateUploadedFilesDisplay();
        updateStats();

        console.log("File Upload System initialized");
      }

      function setupEventListeners() {
        // Tab functionality
        document.querySelectorAll(".tab-button").forEach((button) => {
          button.addEventListener("click", function () {
            const tabName = this.dataset.tab;
            switchTab(tabName);
          });
        });

        // File upload
        const fileInput = document.getElementById("file-upload");
        if (fileInput) {
          fileInput.addEventListener("change", handleFileSelect);
        }

        // Search functionality
        const searchInput = document.getElementById("file-search");
        if (searchInput) {
          searchInput.addEventListener("input", handleFileSearch);
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById("upload-area");
        if (uploadArea) {
          uploadArea.addEventListener("click", () => {
            document.getElementById("file-upload").click();
          });

          uploadArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            uploadArea.classList.add("border-blue-500", "bg-blue-50");
          });

          uploadArea.addEventListener("dragleave", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("border-blue-500", "bg-blue-50");
          });

          uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("border-blue-500", "bg-blue-50");
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
          });
        }
      }

      // Search functionality
      function handleFileSearch(e) {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm === "") {
          filteredFiles = uploadedFiles;
        } else {
          filteredFiles = uploadedFiles.filter(
            (file) =>
              file.name.toLowerCase().includes(searchTerm) ||
              file.type.toLowerCase().includes(searchTerm) ||
              file.status.toLowerCase().includes(searchTerm)
          );
        }
        updateUploadedFilesDisplay();
      }

      // Tab functionality
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active", "border-blue-500", "text-blue-600");
          btn.classList.add("border-transparent", "text-gray-500");
        });
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
          activeTab.classList.add("active", "border-blue-500", "text-blue-600");
          activeTab.classList.remove("border-transparent", "text-gray-500");
        }

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.add("hidden");
        });
        const activeContent = document.getElementById(`${tabName}-tab`);
        if (activeContent) {
          activeContent.classList.remove("hidden");
        }
      }

      function switchToUpload() {
        switchTab("upload");
      }

      function switchToUploadedFiles() {
        switchTab("uploaded-files");
      }

      // File handling
      function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
      }

      async function handleFiles(files) {
        selectedFiles = files;
        updateSelectedFilesDisplay();
        updateUploadButtons();
      }

      function updateSelectedFilesDisplay() {
        const container = document.getElementById("selected-files");
        const list = document.getElementById("selected-files-list");
        const count = document.getElementById("selected-count");

        if (!container || !list || !count) return;

        if (selectedFiles.length === 0) {
          container.classList.add("hidden");
          return;
        }

        container.classList.remove("hidden");
        count.textContent = `${selectedFiles.length} files selected`;

        list.innerHTML = selectedFiles
          .map(
            (file, index) => `
                <div class="flex items-center justify-between p-3">
                    <div class="flex items-center gap-3">
                        ${getFileIcon(file.type)}
                        <div>
                            <p class="font-medium">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(
                              file.size
                            )}</p>
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600" onclick="removeSelectedFile(${index})">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `
          )
          .join("");
      }

      function removeSelectedFile(index) {
        selectedFiles.splice(index, 1);
        updateSelectedFilesDisplay();
        updateUploadButtons();
      }

      function clearAllFiles() {
        selectedFiles = [];
        updateSelectedFilesDisplay();
        updateUploadButtons();
      }

      function updateUploadButtons() {
        const startBtn = document.getElementById("start-upload-btn");
        const cancelBtn = document.getElementById("cancel-upload-btn");
        const uploadMoreBtn = document.getElementById("upload-more-btn");
        const viewFilesBtn = document.getElementById("view-files-btn");

        // Hide all buttons first
        [startBtn, cancelBtn, uploadMoreBtn, viewFilesBtn].forEach((btn) => {
          if (btn) btn.classList.add("hidden");
        });

        if (uploadStatus === "idle" && selectedFiles.length > 0) {
          if (startBtn) startBtn.classList.remove("hidden");
        } else if (uploadStatus === "uploading") {
          if (cancelBtn) cancelBtn.classList.remove("hidden");
        } else if (uploadStatus === "complete") {
          if (uploadMoreBtn) uploadMoreBtn.classList.remove("hidden");
          if (viewFilesBtn) viewFilesBtn.classList.remove("hidden");
        }
      }

      // Upload functionality
      function startUpload() {
        if (selectedFiles.length === 0) {
          alert("Please select files to upload");
          return;
        }

        uploadStatus = "uploading";
        uploadProgress = 0;
        updateUploadStatus();
        updateUploadButtons();

        // Show progress bar
        const progressDiv = document.getElementById("upload-progress");
        if (progressDiv) progressDiv.classList.remove("hidden");

        // Add files to uploaded list with original file references immediately
        const newFiles = selectedFiles.map((file, index) => ({
          id: `UPLOAD-${Date.now()}-${index}`, // Unique ID for each uploaded file
          name: file.name,
          size: formatFileSize(file.size),
          type: file.type || getFileTypeFromName(file.name),
          status: "Uploading...", // Initial status
          date: new Date().toLocaleDateString(),
          file: file, // Store original file reference
        }));

        uploadedFiles = [...newFiles, ...uploadedFiles];
        filteredFiles = uploadedFiles; // Initialize filtered files
        updateUploadedFilesDisplay(); // Update display to show new files as 'Uploading...'

        // Simulate upload progress
        const interval = setInterval(() => {
          uploadProgress += 5;
          updateUploadProgress();

          if (uploadProgress >= 100) {
            clearInterval(interval);
            uploadStatus = "complete";
            updateUploadStatus();
            updateUploadButtons();

            // Update status of newly uploaded files to 'Ready for analysis'
            newFiles.forEach((file) => {
              const index = uploadedFiles.findIndex((f) => f.id === file.id);
              if (index !== -1) {
                uploadedFiles[index].status = "Ready for analysis";
              }
            });
            updateUploadedFilesDisplay(); // Refresh table with new status
            updateStats();

            // Start AI processing for the newly uploaded files
            setTimeout(() => {
              startAiProcessing(newFiles.map((f) => f.id)); // Pass IDs of files to process
            }, 500);
          }
        }, 200);
      }

      function cancelUpload() {
        uploadStatus = "idle";
        uploadProgress = 0;
        updateUploadStatus();
        updateUploadButtons();
        const progressDiv = document.getElementById("upload-progress");
        if (progressDiv) progressDiv.classList.add("hidden");
      }

      function resetUpload() {
        uploadStatus = "idle";
        uploadProgress = 0;
        selectedFiles = [];
        aiProcessingStage = "idle";
        aiProgress = 0;
        extractedMetadata = {}; // Clear extracted metadata

        updateUploadStatus();
        updateSelectedFilesDisplay();
        updateUploadButtons();

        const progressDiv = document.getElementById("upload-progress");
        const aiDiv = document.getElementById("ai-processing");
        if (progressDiv) aiDiv.classList.add("hidden");
        if (progressDiv) progressDiv.classList.add("hidden");
      }

      function updateUploadStatus() {
        const statusText = document.getElementById("uploadStatusText");
        const statusBadge = document.getElementById("uploadStatusBadge");

        if (!statusText || !statusBadge) return;

        let text, badgeText, badgeClass;

        switch (uploadStatus) {
          case "idle":
            text = "Ready";
            badgeText = "Ready";
            badgeClass = "bg-green-100 text-green-800";
            break;
          case "uploading":
            text = "Uploading...";
            badgeText = "Active";
            badgeClass = "bg-blue-100 text-blue-800";
            break;
          case "complete":
            text = "Complete";
            badgeText = "Complete";
            badgeClass = "bg-green-100 text-green-800";
            break;
          case "error":
            text = "Error";
            badgeText = "Error";
            badgeClass = "bg-red-100 text-red-800";
            break;
        }

        statusText.textContent = text;
        statusBadge.textContent = badgeText;
        statusBadge.className = `ml-2 px-2 py-1 text-xs font-medium rounded-full ${badgeClass}`;
      }

      function updateUploadProgress() {
        const percentEl = document.getElementById("upload-progress-percent");
        const barEl = document.getElementById("upload-progress-bar");

        if (percentEl) percentEl.textContent = `${uploadProgress}%`;
        if (barEl) barEl.style.width = `${uploadProgress}%`;
      }

      function updateStats() {
        const todaysEl = document.getElementById("todaysUploads");
        const pendingEl = document.getElementById("pendingIndexing");

        if (todaysEl) todaysEl.textContent = uploadedFiles.length;
        if (pendingEl)
          pendingEl.textContent = uploadedFiles.filter(
            (f) => f.status !== "Indexed"
          ).length;
      }

      // AI Processing functionality with real OCR
      async function startAiProcessing(fileIdsToProcess) {
        aiProcessingStage = "analyzing";
        aiProgress = 0;

        const aiDiv = document.getElementById("ai-processing");
        if (aiDiv) aiDiv.classList.remove("hidden");

        updateAiProgress();

        // Show OCR modal
        const ocrModal = document.getElementById("ocr-modal");
        if (ocrModal) ocrModal.classList.remove("hidden");

        try {
          const newExtractedMetadata = {};

          for (let i = 0; i < fileIdsToProcess.length; i++) {
            const fileId = fileIdsToProcess[i];
            const fileEntry = uploadedFiles.find((f) => f.id === fileId);
            if (!fileEntry || !fileEntry.file) {
              console.warn(`File entry not found for ID: ${fileId}`);
              continue;
            }
            const file = fileEntry.file;

            // Update current file being processed
            const currentFileEl = document.getElementById("ocr-current-file");
            if (currentFileEl) {
              currentFileEl.textContent = `Processing: ${file.name}`;
            }

            updateOcrProgress((i / fileIdsToProcess.length) * 25);

            let extractedText = "";

            if (file.type === "application/pdf") {
              extractedText = await extractTextFromPDF(file);
            } else if (file.type.startsWith("image/")) {
              extractedText = await extractTextFromImage(file);
            } else {
              extractedText = `Unsupported file type: ${file.type}`;
            }

            updateOcrProgress(50 + (i / fileIdsToProcess.length) * 50);

            const fileMetadata = extractMetadataFromText(
              extractedText,
              file.name
            );
            newExtractedMetadata[fileId] = {
              // Key by the uploadedFile's ID
              ...fileMetadata,
              originalFileName: file.name,
              extractedText: extractedText,
              fileSize: formatFileSize(file.size),
              fileType: file.type,
              file: file, // Store original file reference
            };

            // Update the status of the file in the main uploadedFiles array
            const uploadedFileIndex = uploadedFiles.findIndex(
              (f) => f.id === fileId
            );
            if (uploadedFileIndex !== -1) {
              uploadedFiles[uploadedFileIndex].status = "Analysis Complete";
            }
          }

          updateOcrProgress(100);
          // Merge new extracted metadata with existing
          extractedMetadata = { ...extractedMetadata, ...newExtractedMetadata };

          setTimeout(() => {
            if (ocrModal) ocrModal.classList.add("hidden");

            aiProcessingStage = "extracting";
            aiProgress = 60;
            updateAiProgress();

            setTimeout(() => {
              aiProcessingStage = "creating";
              aiProgress = 90;
              updateAiProgress();

              setTimeout(() => {
                aiProcessingStage = "complete";
                aiProgress = 100;
                updateAiProgress();
                showAnalysisResults();
                updateUploadedFilesDisplay(); // Refresh the table after analysis
                updateStats();
              }, 2000);
            }, 2000);
          }, 1000);
        } catch (error) {
          console.error("Error processing documents:", error);
          if (ocrModal) ocrModal.classList.add("hidden");
          aiProcessingStage = "idle";
          alert("Error processing documents. Please try again.");
        }
      }

      function updateAiProgress() {
        const percentEl = document.getElementById("ai-progress-percent");
        const barEl = document.getElementById("ai-progress-bar");

        if (percentEl) percentEl.textContent = `${Math.round(aiProgress)}%`;
        if (barEl) barEl.style.width = `${aiProgress}%`;

        // Update stage indicators
        const stages = ["analyzing", "extracting", "creating", "complete"];
        const currentIndex = stages.indexOf(aiProcessingStage);

        document.querySelectorAll("[data-stage]").forEach((element, index) => {
          const stage = element.dataset.stage;
          element.className = "text-center p-2 rounded ";

          if (stage === aiProcessingStage) {
            element.className += "bg-blue-100 text-blue-700";
          } else if (index < currentIndex) {
            element.className += "bg-green-100 text-green-700";
          } else {
            element.className += "bg-gray-100 text-gray-500";
          }
        });
      }

      function updateOcrProgress(progress) {
        ocrProgress = progress;
        const percentEl = document.getElementById("ocr-progress-percent");
        const barEl = document.getElementById("ocr-progress-bar");

        if (percentEl) percentEl.textContent = `${Math.round(progress)}%`;
        if (barEl) barEl.style.width = `${progress}%`;
      }

      function showAnalysisResults() {
        const resultsContainer = document.getElementById("analysis-results");
        const metadataResults = document.getElementById("metadata-results");
        const filesProcessed = document.getElementById("files-processed");

        if (!resultsContainer || !metadataResults || !filesProcessed) return;

        resultsContainer.classList.remove("hidden");
        filesProcessed.textContent = `${
          Object.keys(extractedMetadata).length
        } files processed`;

        // Generate results HTML
        const resultsHTML = Object.entries(extractedMetadata)
          .map(([fileId, data]) => generateMetadataResultHTML(fileId, data))
          .join("");

        metadataResults.innerHTML = resultsHTML;
      }

      function generateMetadataResultHTML(fileId, data) {
        return `
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b">
                        <div class="flex justify-between items-center">
                            <div>
                                <h5 class="font-semibold text-gray-900">${
                                  data.originalFileName
                                }</h5>
                                <p class="text-sm text-gray-600 mt-1">Document successfully analyzed and processed</p>
                            </div>
                            <span class="px-3 py-1 text-sm font-medium rounded-full ${
                              data.confidence > 70
                                ? "bg-green-100 text-green-800 border-green-200"
                                : "bg-amber-100 text-amber-800 border-amber-200"
                            }">
                                ${data.confidence}% confidence
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h6 class="font-medium text-gray-900 border-b pb-2">File Numbers</h6>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">File Number</span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                          data.fileNumberFound
                                            ? "bg-green-50 text-green-700 border-green-200"
                                            : "bg-red-50 text-red-700 border-red-200"
                                        }">
                                            ${
                                              data.fileNumberFound
                                                ? "✓ Detected"
                                                : "⚠ Not Found"
                                            }
                                        </span>
                                    </div>
                                    <div class="text-lg font-mono bg-white p-2 rounded border">
                                        ${
                                          data.extractedFileNumber ||
                                          "No file number detected"
                                        }
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Title</span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                          data.titleFound
                                            ? "bg-green-50 text-green-700 border-green-200"
                                            : "bg-red-50 text-red-700 border-red-200"
                                        }">
                                            ${
                                              data.titleFound
                                                ? "✓ Detected"
                                                : "⚠ Not Found"
                                            }
                                        </span>
                                    </div>
                                    <div class="text-lg bg-white p-2 rounded border">
                                        ${data.titleName || "No title detected"}
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h6 class="font-medium text-gray-900 border-b pb-2">Property Information</h6>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Plot No:</span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                          data.plotNumberFound
                                            ? "bg-green-50 text-green-700 border-green-200"
                                            : "bg-red-50 text-red-700 border-red-200"
                                        }">
                                            ${
                                              data.plotNumberFound
                                                ? "✓ Detected"
                                                : "⚠ Not Found"
                                            }
                                        </span>
                                    </div>
                                    <div class="text-lg bg-white p-2 rounded border">
                                        ${
                                          data.plotNumber ||
                                          "No plot number detected"
                                        }
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Land Use Type</span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                          data.landUseFound
                                            ? "bg-green-50 text-green-700 border-green-200"
                                            : "bg-red-50 text-red-700 border-red-200"
                                        }">
                                            ${
                                              data.landUseFound
                                                ? "✓ Detected"
                                                : "⚠ Not Found"
                                            }
                                        </span>
                                    </div>
                                    <div class="text-lg bg-white p-2 rounded border">
                                        ${
                                          data.landUseType
                                            ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">${data.landUseType}</span>`
                                            : "No land use detected"
                                        }
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">District/Location</span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                          data.districtFound
                                            ? "bg-green-50 text-green-700 border-green-200"
                                            : "bg-red-50 text-red-700 border-red-200"
                                        }">
                                            ${
                                              data.districtFound
                                                ? "✓ Detected"
                                                : "⚠ Not Found"
                                            }
                                        </span>
                                    </div>
                                    <div class="text-lg bg-white p-2 rounded border">
                                        ${
                                          data.district ||
                                          "No district detected"
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-6 gap-3">
                            <button class="inline-flex items-center gap-2 px-3 py-1 text-sm border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors" onclick="document.getElementById('metadata-modal').classList.remove('hidden'); openMetadataEditModal('${fileId}')">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                Preview Document
                            </button>
                            <button class="inline-flex items-center gap-2 px-3 py-1 text-sm border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors" onclick="document.getElementById('metadata-modal').classList.remove('hidden'); openMetadataEditModal('${fileId}')">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit Metadata
                            </button>
                        </div>
                    </div>
                </div>
            `;
      }

      // Real PDF text extraction using PDF.js
      async function extractTextFromPDF(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          let fullText = "";
          let hasExtractableText = false;

          // First try to extract text directly from PDF
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items
              .map((item) => item.str)
              .join(" ");

            if (pageText.trim().length > 0) {
              fullText += `--- Page ${i} ---\n${pageText}\n\n`;
              hasExtractableText = true;
            }
          }

          // If we got good text extraction, return it
          if (hasExtractableText && fullText.trim().length > 50) {
            return fullText;
          }

          // Otherwise, fall back to OCR
          console.log("PDF has no extractable text, using OCR...");
          return await extractTextFromPDFWithOCR(file, pdf);
        } catch (error) {
          console.error("Error processing PDF:", error);
          return `Error processing PDF: ${error.message}`;
        }
      }

      // OCR for scanned PDFs
      async function extractTextFromPDFWithOCR(file, pdf) {
        let ocrText = "";

        for (let i = 1; i <= pdf.numPages; i++) {
          updateOcrProgress(25 + ((i - 1) / pdf.numPages) * 50);

          try {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
              canvasContext: context,
              viewport: viewport,
            };

            await page.render(renderContext).promise;

            // Convert canvas to blob for Tesseract
            const blob = await new Promise((resolve) => {
              canvas.toBlob(resolve, "image/png");
            });

            // Use Tesseract for OCR
            const {
              data: { text },
            } = await Tesseract.recognize(blob, "eng", {
              logger: (m) => {
                if (m.status === "recognizing text") {
                  const progress =
                    25 +
                    ((i - 1) / pdf.numPages) * 50 +
                    (m.progress * 25) / pdf.numPages;
                  updateOcrProgress(progress);
                }
              },
            });

            if (text && text.trim().length > 0) {
              ocrText += `--- Page ${i} (OCR) ---\n${text.trim()}\n\n`;
            }
          } catch (pageError) {
            console.error(`Error processing page ${i}:`, pageError);
            ocrText += `--- Page ${i} (OCR) ---\nError processing this page\n\n`;
          }
        }

        return (
          ocrText ||
          `PDF Document: ${file.name}\nNo readable text could be extracted.`
        );
      }

      // Real image OCR using Tesseract.js
      async function extractTextFromImage(file) {
        try {
          const {
            data: { text },
          } = await Tesseract.recognize(file, "eng", {
            logger: (m) => {
              if (m.status === "recognizing text") {
                updateOcrProgress(50 + m.progress * 50);
              }
            },
          });
          return text || "No text could be extracted from this image.";
        } catch (error) {
          console.error("Error during OCR:", error);
          return `Error during OCR: ${error.message}`;
        }
      }

      // Enhanced metadata extraction
      function extractMetadataFromText(text, fileName) {
        const defaultMetadata = {
          extractedFileNumber: "",
          fileNumberFound: false,
          oldFileNumber: "",
          oldFileNumberFound: false,
          plotNumber: "",
          plotNumberFound: false,
          detectedOwner: "",
          ownerFound: false,
          titleName: "",
          titleFound: false,
          landUseType: "",
          landUseFound: false,
          district: "",
          districtFound: false,
          documentType: determineDocumentType(fileName, ""),
          documentTypeFound: false,
          confidence: 0,
          pageCount: 1,
          hasSignature: false,
          hasStamp: false,
          quality: "Poor - No text extracted",
          readyForPageTyping: false,
          extractionStatus: "No readable text found",
          hasCertificate: false,
          hasTransaction: false,
          isCoOwned: false,
          isMerged: false,
        };

        if (!text || text.trim() === "") {
          return defaultMetadata;
        }

        const cleanText = text.replace(/\s+/g, " ").trim();

        // Enhanced TITLE field extraction
        let titleName = "";
        let titleFound = false;

        // Look for "TITLE" followed by the contents (until end of line or next field)
        const titleMatch = text.match(/TITLE[:\s]*([^\n]+)/i);
        if (titleMatch && titleMatch[1]) {
          titleName = titleMatch[1].trim();
          // Clean up common OCR artifacts
          titleName = titleName
            .replace(/[^a-zA-Z0-9\s]/g, "") // Remove special chars except spaces
            .replace(/\s+/g, " ") // Collapse multiple spaces
            .trim();

          // Validate we got meaningful content (not just a few characters)
          if (titleName.length >= 3) {
            titleFound = true;
          }
        }

        // Set owner name from title if found
        const ownerName = titleFound ? titleName : "";
        const ownerFound = titleFound;

        // File number extraction
        let newFileNumber = "";
        let newFileNumberFound = false;

        if (fileName) {
          const fileNamePattern = /^([A-Z]+)_(\d{4})_(\d+)/i;
          const match = fileName.match(fileNamePattern);
          if (match) {
            newFileNumber = `${match[1].toUpperCase()}-${match[2]}-${match[3]}`;
            newFileNumberFound = true;
          }
        }

        if (!newFileNumberFound) {
          const newFileNumberPatterns = [
            /NEW FILE NUMBER\s+MLKN\s+(\d+)/gi,
            /KANGIS FILE NO\s+MLKN\s+(\d+)/gi,
            /MLKN\s+(\d+)/gi,
          ];

          for (const pattern of newFileNumberPatterns) {
            const matches = [...cleanText.matchAll(pattern)];
            if (matches.length > 0 && !newFileNumberFound) {
              const match = matches[0];
              if (match[1]) {
                const number = match[1].padStart(6, "0");
                newFileNumber = `MLKN ${number}`;
                newFileNumberFound = true;
                break;
              }
            }
          }
        }

        // Old file number extraction
        let oldFileNumber = "";
        let oldFileNumberFound = false;
        const oldFileNumberPatterns = [
          /OLD FILE NUMBER\s+([A-Z]+\/\d{4}\/\d+)/gi,
          /OLD FILE NO\s+([A-Z]+\/\d{4}\/\d+)/gi,
          /([A-Z]+\/\d{4}\/\d+)/gi,
        ];

        for (const pattern of oldFileNumberPatterns) {
          const matches = [...cleanText.matchAll(pattern)];
          if (matches.length > 0 && !oldFileNumberFound) {
            const match = matches[0];
            if (match[1]) {
              oldFileNumber = match[1];
              oldFileNumberFound = true;
              break;
            }
          }
        }

        // Plot number extraction
        let plotNumber = "";
        let plotNumberFound = false;
        const plotNumberPatterns = [
          /PLOT NUMBER\s+([A-Z]?\d+[A-Z]?)/gi,
          /PLOT NO\s+([A-Z]?\d+[A-Z]?)/gi,
          /PLOT\s+([A-Z]?\d+[A-Z]?)/gi,
        ];

        for (const pattern of plotNumberPatterns) {
          const matches = [...cleanText.matchAll(pattern)];
          if (matches.length > 0 && !plotNumberFound) {
            const match = matches[0];
            if (match[1]) {
              plotNumber = match[1];
              plotNumberFound = true;
              break;
            }
          }
        }

        let landUseType = "";
        let landUseFound = false;

        // First try to determine from file number prefix
        if (newFileNumber) {
          const prefix =
            newFileNumber.split("-")[0] || newFileNumber.split(" ")[0];
          switch (prefix.toUpperCase()) {
            case "COM":
              landUseType = "COMMERCIAL";
              landUseFound = true;
              break;
            case "RES":
              landUseType = "RESIDENTIAL";
              landUseFound = true;
              break;
            case "IND":
              landUseType = "INDUSTRIAL";
              landUseFound = true;
              break;
            case "AGR":
              landUseType = "AGRICULTURAL";
              landUseFound = true;
              break;
            case "MIX":
              landUseType = "MIXED USE";
              landUseFound = true;
              break;
            default:
              // Continue to OCR-based extraction
              break;
          }
        }

        if (!landUseFound) {
          const landUsePatterns = [
            /LAND USE\s+([A-Z\s]+)/gi,
            /USE\s+([A-Z\s]+)/gi,
            /(RESIDENTIAL|COMMERCIAL|INDUSTRIAL|AGRICULTURAL|MIXED USE)/gi,
          ];

          for (const pattern of landUsePatterns) {
            const matches = [...cleanText.matchAll(pattern)];
            if (matches.length > 0 && !landUseFound) {
              const match = matches[0];
              if (match[1]) {
                landUseType = match[1].trim().toUpperCase();
                landUseFound = true;
                break;
              }
            }
          }
        }

        let district = "";
        let districtFound = false;
        const districtPatterns = [
          /DISTRICT\s+([A-Z\s]+)/gi,
          /LGA\s+([A-Z\s]+)/gi,
          /LOCAL GOVERNMENT\s+([A-Z\s]+)/gi,
        ];

        for (const pattern of districtPatterns) {
          const matches = [...cleanText.matchAll(pattern)];
          if (matches.length > 0 && !districtFound) {
            const match = matches[0];
            if (match[1]) {
              district = match[1].trim();
              districtFound = true;
              break;
            }
          }
        }

        const extractionCount = [
          newFileNumberFound,
          oldFileNumberFound,
          plotNumberFound,
          ownerFound,
          titleFound,
          landUseFound,
          districtFound,
        ].filter(Boolean).length;

        const confidence = Math.round((extractionCount / 7) * 100);

        let quality = "Poor - Limited extraction";
        let extractionStatus = "Partial extraction completed";

        if (confidence >= 80) {
          quality = "Excellent - High confidence extraction";
          extractionStatus = "Successfully extracted";
        } else if (confidence >= 60) {
          quality = "Good - Moderate confidence extraction";
          extractionStatus = "Successfully extracted";
        } else if (confidence >= 40) {
          quality = "Fair - Basic extraction completed";
          extractionStatus = "Basic extraction completed";
        }

        return {
          extractedFileNumber: newFileNumber,
          fileNumberFound: newFileNumberFound,
          oldFileNumber: oldFileNumber,
          oldFileNumberFound: oldFileNumberFound,
          plotNumber: plotNumber,
          plotNumberFound: plotNumberFound,
          detectedOwner: ownerName,
          ownerFound: ownerFound,
          titleName: titleName,
          titleFound: titleFound,
          landUseType: landUseType,
          landUseFound: landUseFound,
          district: district,
          districtFound: districtFound,
          documentType: determineDocumentType(fileName, cleanText),
          documentTypeFound: true,
          confidence: confidence,
          pageCount: 1,
          hasSignature:
            cleanText.toLowerCase().includes("signature") ||
            cleanText.toLowerCase().includes("signed"),
          hasStamp:
            cleanText.toLowerCase().includes("stamp") ||
            cleanText.toLowerCase().includes("seal"),
          quality: quality,
          readyForPageTyping: confidence >= 40,
          extractionStatus: extractionStatus,
        };
      }

      function determineDocumentType(fileName, text) {
        const lowerFileName = fileName.toLowerCase();
        const lowerText = text.toLowerCase();

        if (lowerFileName.includes("title") || lowerText.includes("title")) {
          return "Title Deed";
        } else if (
          lowerFileName.includes("lease") ||
          lowerText.includes("lease")
        ) {
          return "Lease Agreement";
        } else if (
          lowerFileName.includes("transfer") ||
          lowerText.includes("transfer")
        ) {
          return "Transfer Document";
        } else if (
          lowerFileName.includes("mortgage") ||
          lowerText.includes("mortgage")
        ) {
          return "Mortgage Document";
        } else {
          return "Unknown Document";
        }
      }

      // Helper functions
      function getFileIcon(fileType) {
        if (fileType === "application/pdf") {
          return `<svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>`;
        } else if (fileType.startsWith("image/")) {
          return `<svg class="h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L20 20M5 13h.007v.008H5V13z"></path>
                        </svg>`;
        } else {
          return `<svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                        </svg>`;
        }
      }

      function getFileTypeFromName(filename) {
        const extension = filename.split(".").pop().toLowerCase();
        const types = {
          pdf: "application/pdf",
          jpg: "image/jpeg",
          jpeg: "image/jpeg",
          png: "image/png",
          gif: "image/gif",
          bmp: "image/bmp",
          tiff: "image/tiff",
          tif: "image/tiff",
          webp: "image/webp",
        };
        return types[extension] || "application/octet-stream";
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Uploaded files display
      function updateUploadedFilesDisplay() {
        const container = document.getElementById("uploaded-files-list");
        const footer = document.getElementById("uploaded-files-footer");

        if (!container || !footer) return;

        if (uploadedFiles.length === 0) {
          container.innerHTML =
            '<p class="p-4 text-gray-500">No files uploaded yet</p>';
          footer.classList.add("hidden");
          return;
        }

        footer.classList.remove("hidden");

        const filesToDisplay =
          filteredFiles.length > 0 ? filteredFiles : uploadedFiles;

        container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)">
                                    <span class="checkmark"></span>
                                </label>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${filesToDisplay
                          .map(
                            (file) => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <label class="checkbox-container">
                                        <input type="checkbox" class="file-checkbox" data-file-id="${
                                          file.id
                                        }" onchange="updateSelectedFiles('${
                              file.id
                            }', this.checked)">
                                        <span class="checkmark"></span>
                                    </label>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        ${getFileIcon(file.type)}
                                        <div class="ml-2">${file.name}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">${
                                  file.size
                                }</td>
                                <td class="px-6 py-4 whitespace-nowrap">${
                                  file.type
                                }</td>
                                <td class="px-6 py-4 whitespace-nowrap">${
                                  file.date
                                }</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(
                                      file.status
                                    )}">${file.status}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <button class="text-blue-500 hover:text-blue-700" onclick="openMetadataEditModal('${
                                      file.id
                                    }')">Edit Metadata</button>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        // Update the select all checkbox state
        updateSelectAllCheckbox();
      }

      function getStatusBadgeClass(status) {
        switch (status) {
          case "Uploading...":
            return "bg-blue-100 text-blue-800";
          case "Ready for analysis":
            return "bg-yellow-100 text-yellow-800";
          case "Analysis Complete":
            return "bg-green-100 text-green-800";
          case "Indexed":
            return "bg-green-200 text-green-900";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      // New functions for selection handling
      function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll(".file-checkbox");
        checkboxes.forEach((cb) => {
          cb.checked = checkbox.checked;
          updateSelectedFiles(cb.dataset.fileId, cb.checked);
        });
      }

      function updateSelectedFiles(fileId, isSelected) {
        if (isSelected) {
          if (!selectedFileIds.includes(fileId)) {
            selectedFileIds.push(fileId);
          }
        } else {
          selectedFileIds = selectedFileIds.filter((id) => id !== fileId);
        }

        updateSelectionUI();
      }

      function updateSelectionUI() {
        const selectedCountDisplay = document.getElementById(
          "selected-count-display"
        );
        const selectedCount = document.getElementById("selected-files-count");
        const sendSelectedBtn = document.getElementById("send-selected-btn");
        const sendAllBtn = document.getElementById("send-all-btn");

        if (selectedFileIds.length > 0) {
          selectedCountDisplay.classList.remove("hidden");
          selectedCount.textContent = selectedFileIds.length;
          sendSelectedBtn.classList.remove("hidden");
          sendAllBtn.classList.add("hidden");
        } else {
          selectedCountDisplay.classList.add("hidden");
          sendSelectedBtn.classList.add("hidden");
          sendAllBtn.classList.remove("hidden");
        }

        updateSelectAllCheckbox();
      }

      function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById(
          "select-all-checkbox"
        );
        if (!selectAllCheckbox) return;

        const checkboxes = document.querySelectorAll(".file-checkbox");
        if (checkboxes.length === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
          return;
        }

        const checkedCount = Array.from(checkboxes).filter(
          (cb) => cb.checked
        ).length;

        if (checkedCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === checkboxes.length) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }

      // Updated indexing functions
      function sendSelectedToIndexing() {
        if (selectedFileIds.length === 0) {
          alert("Please select at least one file to send to indexing");
          return;
        }

        const selectedFiles = uploadedFiles.filter((file) =>
          selectedFileIds.includes(file.id)
        );
        const fileNames = selectedFiles.map((file) => file.name).join(", ");

        alert(`Sending selected files to indexing: ${fileNames}`);

        // Here you would typically make an API call to send the selected files
        // For now, we'll just update their status
        uploadedFiles = uploadedFiles.map((file) => {
          if (selectedFileIds.includes(file.id)) {
            return { ...file, status: "Indexed" };
          }
          return file;
        });

        // Clear selection
        selectedFileIds = [];
        updateSelectionUI();
        updateUploadedFilesDisplay();
        updateStats();
      }

      function sendToIndexing() {
        if (uploadedFiles.length === 0) {
          alert("No files to send to indexing");
          return;
        }

        alert("Sending all files to indexing...");

        // Here you would typically make an API call to send all files
        // For now, we'll just update their status
        uploadedFiles = uploadedFiles.map((file) => ({
          ...file,
          status: "Indexed",
        }));

        updateUploadedFilesDisplay();
        updateStats();
      }

      // Metadata modal functions
      function openMetadataEditModal(fileId) {
        currentEditingFile = fileId;
        const modal = document.getElementById("metadata-modal");
        const title = document.getElementById("metadata-modal-title");
        const form = document.getElementById("metadata-form");
        const previewContent = document.getElementById(
          "metadata-preview-content"
        );
        const extractedTextPreview = document.getElementById(
          "metadata-extracted-text-preview"
        );

        if (
          !modal ||
          !title ||
          !form ||
          !previewContent ||
          !extractedTextPreview
        )
          return;

        modal.classList.remove("hidden");
        title.textContent = `Edit Metadata for ${extractedMetadata[fileId].originalFileName}`;
        form.innerHTML = generateMetadataForm(fileId);
        extractedTextPreview.textContent =
          extractedMetadata[fileId].extractedText;

        // Load preview
        loadDocumentPreview(fileId);
      }

      function closeMetadataModal() {
        const modal = document.getElementById("metadata-modal");
        if (modal) modal.classList.add("hidden");
        currentEditingFile = null;
        clearDocumentPreview();
      }

      function saveMetadata() {
        console.log("All forms on page:", document.forms);
        console.log("Form by ID:", document.getElementById("metadata-form"));
        if (!currentEditingFile) return;

        const form = document.getElementById("metadata-form");
        if (!form) return;

        const formData = new FormData(form);
        const updatedMetadata = {
          extractedFileNumber: formData.get("extractedFileNumber"),
          oldFileNumber: formData.get("oldFileNumber"),
          plotNumber: formData.get("plotNumber"),
          titleName: formData.get("titleName"),
          landUseType: formData.get("landUseType"),
          district: formData.get("district"),
        };

        // Update the extractedMetadata object
        extractedMetadata[currentEditingFile] = {
          ...extractedMetadata[currentEditingFile],
          ...updatedMetadata,
        };

        // Update the uploadedFiles array (if needed)
        const uploadedFileIndex = uploadedFiles.findIndex(
          (f) => f.id === currentEditingFile
        );
        if (uploadedFileIndex !== -1) {
          // You might want to update some fields in the uploadedFiles array as well
          // For example, if you want to update the file name:
          // uploadedFiles[uploadedFileIndex].name = updatedMetadata.detectedOwner;
        }

        closeMetadataModal();
        updateUploadedFilesDisplay();
      }

      function generateMetadataForm(fileId) {
        const data = extractedMetadata[fileId];
        return `
        <div class="space-y-4">
            <div>
                <label for="extractedFileNumber" class="block text-sm font-medium text-gray-700">File Number</label>
                <input type="text" name="extractedFileNumber" id="extractedFileNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${
                  data.extractedFileNumber || ""
                }">
            </div>
            <div>
                <label for="oldFileNumber" class="block text-sm font-medium text-gray-700">Old File Number</label>
                <input type="text" name="oldFileNumber" id="oldFileNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${
                  data.oldFileNumber || ""
                }">
            </div>
            <div>
                <label for="plotNumber" class="block text-sm font-medium text-gray-700">Plot Number</label>
                <input type="text" name="plotNumber" id="plotNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${
                  data.plotNumber || ""
                }">
            </div>
            <div>
                <label for="titleName" class="block text-sm font-medium text-gray-700">Title</label>
                <div class="flex items-center justify-between">
                    <input type="text" name="titleName" id="titleName" 
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                        value="${data.titleName || ""}">
                    <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full ${
                      data.titleFound
                        ? "bg-green-100 text-green-800"
                        : "bg-red-100 text-red-800"
                    }">
                        ${data.titleFound ? "✓ Detected" : "⚠ Not Found"}
                    </span>
                </div>
            </div>
            <div>
                <label for="landUseType" class="block text-sm font-medium text-gray-700">Land Use Type</label>
                <select name="landUseType" id="landUseType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">Select Land Use</option>
                    <option value="RESIDENTIAL" ${
                      data.landUseType === "RESIDENTIAL" ? "selected" : ""
                    }>Residential</option>
                    <option value="COMMERCIAL" ${
                      data.landUseType === "COMMERCIAL" ? "selected" : ""
                    }>Commercial</option>
                    <option value="INDUSTRIAL" ${
                      data.landUseType === "INDUSTRIAL" ? "selected" : ""
                    }>Industrial</option>
                    <option value="AGRICULTURAL" ${
                      data.landUseType === "AGRICULTURAL" ? "selected" : ""
                    }>Agricultural</option>
                    <option value="MIXED USE" ${
                      data.landUseType === "MIXED USE" ? "selected" : ""
                    }>Mixed Use</option>
                </select>
            </div>
            <div>
                <label for="district" class="block text-sm font-medium text-gray-700">District</label>
                <input type="text" name="district" id="district" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${
                  data.district || ""
                }">
            </div>
            
            <!-- Property Status Checkboxes -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Property Status</label>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="hasCertificate" name="hasCertificate" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${
                          data.hasCertificate ? "checked" : ""
                        }>
                        <label for="hasCertificate" class="ml-2 block text-sm text-gray-700">Has Certificate of Occupancy</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="hasTransaction" name="hasTransaction" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${
                          data.hasTransaction ? "checked" : ""
                        }>
                        <label for="hasTransaction" class="ml-2 block text-sm text-gray-700">Has Transaction</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="isCoOwned" name="isCoOwned" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${
                          data.isCoOwned ? "checked" : ""
                        }>
                        <label for="isCoOwned" class="ml-2 block text-sm text-gray-700">Co-Owned Plot</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="isMerged" name="isMerged" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${
                          data.isMerged ? "checked" : ""
                        }>
                        <label for="isMerged" class="ml-2 block text-sm text-gray-700">Merged Plot</label>
                    </div>
                </div>
            </div>
        </div>
    `;
      }

      // Document preview functions
      async function loadDocumentPreview(fileId) {
        const fileEntry = uploadedFiles.find((f) => f.id === fileId);
        if (!fileEntry || !fileEntry.file) {
          console.warn(`File entry not found for ID: ${fileId}`);
          return;
        }

        const file = fileEntry.file;
        const previewContent = document.getElementById(
          "metadata-preview-content"
        );
        const pdfPreviewWrapper = document.getElementById(
          "pdf-preview-wrapper"
        );
        const imagePreviewWrapper = document.getElementById(
          "image-preview-wrapper"
        );
        const unsupportedMessage = document.getElementById(
          "unsupported-preview-message"
        );

        if (
          !previewContent ||
          !pdfPreviewWrapper ||
          !imagePreviewWrapper ||
          !unsupportedMessage
        )
          return;

        // Hide all previews first
        pdfPreviewWrapper.classList.add("hidden");
        imagePreviewWrapper.classList.add("hidden");
        unsupportedMessage.classList.add("hidden");

        if (file.type === "application/pdf") {
          await loadPdfPreview(file);
        } else if (file.type.startsWith("image/")) {
          await loadImagePreview(file);
        } else {
          unsupportedMessage.classList.remove("hidden");
        }
      }

      async function loadPdfPreview(file) {
        const pdfPreviewWrapper = document.getElementById(
          "pdf-preview-wrapper"
        );
        const pdfLoadingPlaceholder = document.getElementById(
          "pdf-loading-placeholder"
        );
        const pdfCanvas = document.getElementById("pdf-preview-canvas");
        const pdfNavigationControls = document.getElementById(
          "pdf-navigation-controls"
        );
        const pageInfo = document.getElementById("page-info");
        const prevPageBtn = document.getElementById("prev-page-btn");
        const nextPageBtn = document.getElementById("next-page-btn");

        if (
          !pdfPreviewWrapper ||
          !pdfLoadingPlaceholder ||
          !pdfCanvas ||
          !pdfNavigationControls ||
          !pageInfo ||
          !prevPageBtn ||
          !nextPageBtn
        )
          return;

        pdfPreviewWrapper.classList.remove("hidden");
        pdfLoadingPlaceholder.classList.remove("hidden");
        pdfCanvas.classList.add("hidden");
        pdfNavigationControls.classList.add("hidden");

        try {
          const arrayBuffer = await file.arrayBuffer();
          currentPDFDocument = await pdfjsLib.getDocument({ data: arrayBuffer })
            .promise;
          currentPageNumber = 1;

          await renderPdfPage(currentPageNumber);

          pdfLoadingPlaceholder.classList.add("hidden");
          pdfCanvas.classList.remove("hidden");
          pdfNavigationControls.classList.remove("hidden");

          // Update page info
          pageInfo.textContent = `Page ${currentPageNumber} of ${currentPDFDocument.numPages}`;

          // Enable/disable navigation buttons
          prevPageBtn.disabled = currentPageNumber <= 1;
          nextPageBtn.disabled =
            currentPageNumber >= currentPDFDocument.numPages;
        } catch (error) {
          console.error("Error loading PDF preview:", error);
          pdfLoadingPlaceholder.textContent = "Error loading PDF preview.";
        }
      }

      async function renderPdfPage(pageNumber) {
        const pdfCanvas = document.getElementById("pdf-preview-canvas");
        if (!pdfCanvas || !currentPDFDocument) return;

        const page = await currentPDFDocument.getPage(pageNumber);
        const viewport = page.getViewport({ scale: 1.5 });
        const context = pdfCanvas.getContext("2d");
        pdfCanvas.height = viewport.height;
        pdfCanvas.width = viewport.width;

        const renderContext = {
          canvasContext: context,
          viewport: viewport,
        };

        await page.render(renderContext).promise;
      }

      async function loadImagePreview(file) {
        const imagePreviewWrapper = document.getElementById(
          "image-preview-wrapper"
        );
        const imageLoadingPlaceholder = document.getElementById(
          "image-loading-placeholder"
        );
        const imagePreviewImg = document.getElementById("image-preview-img");

        if (
          !imagePreviewWrapper ||
          !imageLoadingPlaceholder ||
          !imagePreviewImg
        )
          return;

        imagePreviewWrapper.classList.remove("hidden");
        imageLoadingPlaceholder.classList.remove("hidden");
        imagePreviewImg.classList.add("hidden");

        imagePreviewImg.onload = () => {
          imageLoadingPlaceholder.classList.add("hidden");
          imagePreviewImg.classList.remove("hidden");
        };

        imagePreviewImg.onerror = () => {
          imageLoadingPlaceholder.textContent = "Error loading image preview.";
        };

        imagePreviewImg.src = URL.createObjectURL(file);
      }

      function clearDocumentPreview() {
        const pdfCanvas = document.getElementById("pdf-preview-canvas");
        const imagePreviewImg = document.getElementById("image-preview-img");

        if (pdfCanvas) {
          const context = pdfCanvas.getContext("2d");
          context.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
        }

        if (imagePreviewImg) {
          imagePreviewImg.src = "/placeholder.svg";
        }

        currentPDFDocument = null;
        currentPageNumber = 1;
      }

      function goToPreviousPage() {
        if (!currentPDFDocument || currentPageNumber <= 1) return;
        currentPageNumber--;
        renderPdfPage(currentPageNumber);
        updatePageInfo();
      }

      function goToNextPage() {
        if (
          !currentPDFDocument ||
          currentPageNumber >= currentPDFDocument.numPages
        )
          return;
        currentPageNumber++;
        renderPdfPage(currentPageNumber);
        updatePageInfo();
      }

      function updatePageInfo() {
        const pageInfo = document.getElementById("page-info");
        const prevPageBtn = document.getElementById("prev-page-btn");
        const nextPageBtn = document.getElementById("next-page-btn");

        if (!pageInfo || !prevPageBtn || !nextPageBtn) return;

        pageInfo.textContent = `Page ${currentPageNumber} of ${currentPDFDocument.numPages}`;
        prevPageBtn.disabled = currentPageNumber <= 1;
        nextPageBtn.disabled = currentPageNumber >= currentPDFDocument.numPages;
      }

      // Indexing functions
      function createIndexingEntries() {
        // Placeholder function
        alert("Creating indexing entries...");
      }
    </script>
  </body>
</html>
